{% set activeAppearance = appearance ?? null %}
{% if activeAppearance is iterable %}
  {% set tokens = activeAppearance.tokens|default({}) %}
  {% set defaults = activeAppearance.defaults|default({}) %}
  {% set colors = activeAppearance.colors|default({}) %}
  {% set variables = activeAppearance.variables|default({}) %}

  {% set defaultBrand = defaults.brand|default({}) %}
  {% set defaultLayout = defaults.layout|default({}) %}
  {% set defaultTypography = defaults.typography|default({}) %}
  {% set defaultComponents = defaults.components|default({}) %}

  {% set brand = tokens.brand|default({}) %}
  {% set layout = tokens.layout|default({}) %}
  {% set typography = tokens.typography|default({}) %}
  {% set components = tokens.components|default({}) %}

  {% set brandPrimary = colors.primary ?? brand.primary ?? defaultBrand.primary ?? null %}
  {% set brandAccent = colors.secondary ?? colors.accent ?? brand.accent ?? defaultBrand.accent ?? null %}
  {% set layoutProfile = layout.profile ?? defaultLayout.profile ?? null %}
  {% set typographyPreset = typography.preset ?? defaultTypography.preset ?? null %}
  {% set cardStyle = components.cardStyle ?? defaultComponents.cardStyle ?? null %}
  {% set buttonStyle = components.buttonStyle ?? defaultComponents.buttonStyle ?? null %}

  {% set surface = colors.surface|default(variables.surface|default(null))|trim %}
  {% set surfaceMuted = colors.muted|default(variables.surfaceMuted|default(null))|trim %}
  {% set topbarLight = colors.topbar_light|default(colors.topbarLight|default(variables.topbarLight|default(null)))|trim %}
  {% set topbarDark = colors.topbar_dark|default(colors.topbarDark|default(variables.topbarDark|default(null)))|trim %}

  <style data-namespace-appearance>
    [data-namespace="{{ namespace|e('css') }}"] {
      --brand-primary: {{ brandPrimary|trim|e('css') }};
      --accent-primary: {{ brandPrimary|trim|e('css') }};
      --brand-accent: {{ brandAccent|trim|e('css') }};
      --accent-secondary: {{ brandAccent|trim|e('css') }};
      --layout-profile: {{ layoutProfile|trim|e('css') }};
      --typography-preset: {{ typographyPreset|trim|e('css') }};
      --components-card-style: {{ cardStyle|trim|e('css') }};
      --components-button-style: {{ buttonStyle|trim|e('css') }};
      --bg-page: var(--surface, var(--brand-surface, #fff));
      --bg-section: var(--surface, var(--brand-surface, #fff));
      --bg-card: var(--surface, var(--brand-surface, #fff));
      --bg-accent: var(--brand-primary);
      --surface: {{ surface ? surface|e('css') : 'var(--brand-surface, #fff)' }};
      --surface-muted: {{ surfaceMuted ? surfaceMuted|e('css') : 'var(--surface, var(--brand-surface, #fff))' }};
      {% if topbarLight %}
      --qr-landing-topbar-bg-light: {{ topbarLight|e('css') }};
      {% endif %}
      {% if topbarDark %}
      --qr-landing-topbar-bg-dark: {{ topbarDark|e('css') }};
      {% endif %}
    }
  </style>
{% endif %}
