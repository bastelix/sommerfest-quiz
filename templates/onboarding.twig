{% extends 'layout.twig' %}

{% block title %}Onboarding{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ basePath }}/css/main.css">
  <link rel="stylesheet" href="{{ basePath }}/css/dark.css" media="all">
  <link rel="stylesheet" href="{{ basePath }}/css/highcontrast.css">
  <link rel="stylesheet" href="{{ basePath }}/css/onboarding.css">
  <script async src="https://js.stripe.com/v3/pricing-table.js"></script>
{% endblock %}

{% block body_class %}uk-padding{% endblock %}

{% block body %}
  {% embed 'topbar.twig' %}
    {% block left %}
      <a href="{{ basePath }}/landing" class="uk-icon-button" uk-icon="icon: arrow-left; ratio: 2" title="Zurück" aria-label="Zurück"></a>
    {% endblock %}
  {% endembed %}
  <div class="uk-container uk-margin-large-top">
    {% if stripe_error %}
      <div class="uk-alert-danger" uk-alert>
        <p>{{ stripe_error }}</p>
      </div>
    {% endif %}

    {% if not stripe_configured %}
      <div class="uk-alert-danger" uk-alert>
        <p>Stripe ist unvollständig konfiguriert.</p>
        <ul>
          {% for key in stripe_missing %}
            <li>{{ key }} fehlt</li>
          {% endfor %}
        </ul>
      </div>
    {% elseif stripe_warnings|length %}
      <div class="uk-alert-warning" uk-alert>
        <p>Stripe-Warnungen:</p>
        <ul>
          {% for w in stripe_warnings %}
            <li>{{ w }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
    <ul class="onboarding-timeline uk-flex uk-flex-center uk-margin-bottom" id="stepTimeline">
      <li class="timeline-step active" data-step="1">1. E-Mail</li>
      <li class="timeline-step" data-step="2">2. Subdomain</li>
      <li class="timeline-step" data-step="3">3. Impressum</li>
      <li class="timeline-step inactive" data-step="4">4. Tarif</li>
      <li class="timeline-step inactive" data-step="5">5. App erstellen</li>
    </ul>
    <div class="uk-text-center uk-margin">
      <button class="uk-button uk-button-default" id="restartOnboarding">Neu starten</button>
    </div>
    <div class="uk-card qr-card uk-card-body onboarding-step uk-width-1-1 uk-width-1-2@m uk-margin-auto" id="step1">
      <h3 class="uk-card-title">1. E-Mail eingeben und bestätigen</h3>
      <div class="uk-margin">
        <input id="email" class="uk-input" type="email" placeholder="E-Mail-Adresse" required>
      </div>
      <p>Nach Klick auf die Schaltfläche verschicken wir eine E-Mail mit einem Bestätigungslink. Öffne diesen Link, um deine Adresse zu verifizieren und die Registrierung fortzusetzen.</p>
      <button class="uk-button uk-button-primary" id="sendEmail">Bestätigung senden</button>
      <div id="emailStatus" class="uk-margin-small-top uk-text-success" hidden></div>
    </div>

    <div class="uk-card qr-card uk-card-body onboarding-step uk-width-1-1 uk-width-1-2@m uk-margin-auto" id="step2" hidden>
      <h3 class="uk-card-title">2. Subdomain wählen</h3>
      <div id="verifiedHint" class="uk-alert-success" uk-alert hidden>
        <p>Deine E-Mail-Adresse wurde erfolgreich bestätigt.</p>
      </div>
      <div class="uk-margin">
        <label for="subdomain" class="uk-form-label">Subdomain</label>
        <input id="subdomain" class="uk-input" type="text" placeholder="gewünschte Subdomain" maxlength="63" required>
        <div id="subdomainStatus" class="uk-margin-small-top" hidden></div>
        <div class="uk-margin-small-top uk-text-meta">Die vollständige Adresse lautet: <span id="subdomainPreview"></span>.{{ main_domain }}</div>
      </div>
      <p>Gib eine gewünschte Subdomain ein (z.&nbsp;B. <code>meine-seite</code>) und bestätige mit der Schaltfläche. Wir prüfen die Verfügbarkeit und reservieren sie für dich.</p>
      <button class="uk-button uk-button-primary" id="saveSubdomain">Subdomain speichern</button>
    </div>

    <div class="uk-card qr-card uk-card-body onboarding-step uk-width-1-1 uk-margin-auto" id="step3" hidden>
      <h3 class="uk-card-title">3. Rechnungsdaten</h3>
      <div class="uk-margin"><input id="imprintName" class="uk-input" type="text" placeholder="Name/Firma" required></div>
      <div class="uk-margin"><input id="imprintStreet" class="uk-input" type="text" placeholder="Straße und Hausnummer" required></div>
      <div class="uk-margin"><input id="imprintZip" class="uk-input" type="text" placeholder="PLZ" required></div>
      <div class="uk-margin"><input id="imprintCity" class="uk-input" type="text" placeholder="Ort" required></div>
      <div class="uk-margin"><input id="imprintEmail" class="uk-input" type="email" placeholder="E-Mail" required></div>
      <div class="uk-margin"><label><input class="uk-checkbox" type="checkbox" id="useAsImprint"> Als Impressum verwenden</label></div>
      <button class="uk-button uk-button-primary" id="saveImprint">Weiter</button>
    </div>

    <div class="uk-card qr-card uk-card-body onboarding-step uk-width-1-1 uk-margin-auto" id="step4" hidden>
      <h3 class="uk-card-title">4. Tarif wählen</h3>
      {% if stripe_configured and stripe_pricing_table_id %}
      <p>Wähle einen Tarif und schließe die Zahlung über Stripe ab. Du kannst jeden kostenpflichtigen Tarif 7 Tage lang kostenlos testen.</p>
      <stripe-pricing-table id="pricingTable" pricing-table-id="{{ stripe_pricing_table_id }}" publishable-key="{{ stripe_publishable_key }}"></stripe-pricing-table>
      <p class="uk-text-meta uk-text-center uk-margin-large-top">Alle Preise zzgl. MwSt. – individuelle Lösungen auf Anfrage.</p>
      <p class="uk-text-meta uk-margin-top">1 (Die Teamgröße ist nicht technisch limitiert und kann bedarfsgerecht festgelegt werden.)</p>
      <p class="uk-text-meta uk-margin-top">2 (Im Starter-Paket mit Wasserzeichen oder ohne individuelles Layout/Logo)</p>
      <p class="uk-text-meta uk-margin-top">3 (z.&nbsp;B. Datenschutz, AGB, Einladung, FAQ, Spielanleitung – alles eigenständig editierbar)</p>
      {% else %}
      <p class="uk-text-danger">Zahlungsdienstleister nicht konfiguriert.</p>
      {% if stripe_missing %}
      <p class="uk-text-meta">Fehlende Variablen: {{ stripe_missing|join(', ') }}</p>
      {% elseif not stripe_pricing_table_id %}
      <p class="uk-text-meta">Pricing-Table-ID fehlt.</p>
      {% endif %}
      {% endif %}
    </div>

      <div class="uk-card qr-card uk-card-body onboarding-step uk-width-1-1 uk-width-1-2@m uk-margin-auto" id="step5" hidden>
        <h3 class="uk-card-title">5. App erstellen</h3>
        <p>Deine App wird erstellt. Bitte warten …</p>
        <ul id="task-status" class="uk-list uk-text-left uk-margin"></ul>
        <details id="task-log-details" class="uk-margin">
          <summary>Log anzeigen</summary>
          <div class="uk-margin-small-top">
            <button type="button" id="copyTaskLog" class="uk-button uk-button-default uk-button-small" hidden>Log kopieren</button>
          </div>
          <ul id="task-log" class="uk-list uk-text-left uk-text-meta uk-margin-small-top"></ul>
        </details>
      </div>
    </div>
  {% endblock %}

{% block scripts %}
  <script>
    window.mainDomain = '{{ main_domain }}';
    window.csrfToken = '{{ csrf_token|e('js') }}';
    window.stripeConfigured = {{ stripe_configured ? 'true' : 'false' }};
  </script>
  <script src="{{ basePath }}/js/onboarding.js"></script>
{% endblock %}

