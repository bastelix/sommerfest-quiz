{% extends 'layout.twig' %}

{% block title %}{{ event.name }} – Bald geht's los{% endblock %}

{% block body_class %}marketing-page marketing-event-upcoming uk-background-muted{% endblock %}

{% block head %}
  <link rel="preload" href="{{ basePath }}/css/marketing.css" as="style">
  <link rel="stylesheet" href="{{ basePath }}/css/marketing.css">
  <meta name="page-name" content="Event upcoming marketing">
  {% set eventConfig = config|default({}) %}
  {% set colorConfig = eventConfig.colors|default({}) %}
  {% set landingPrimary = eventConfig.buttonColor|default(colorConfig.accent|default(null)) %}
  {% set landingBackground = eventConfig.backgroundColor|default(colorConfig.background|default(colorConfig.primary|default(null))) %}
  {% set landingForeground = colorConfig.foreground|default(colorConfig.text|default(null)) %}
  {% set heroStart = colorConfig.heroStart|default(colorConfig.gradientStart|default(landingBackground)) %}
  {% set heroEnd = colorConfig.heroEnd|default(colorConfig.gradientEnd|default(landingPrimary|default(null))) %}
  {% set landingContrast = colorConfig.contrastOnPrimary|default(colorConfig.onPrimary|default(null)) %}
  {% if landingPrimary or landingBackground or landingForeground or heroStart or heroEnd or landingContrast %}
    <style>
      :root {
        {% if landingPrimary %}--qr-landing-primary: {{ landingPrimary }};{% endif %}
        {% if landingBackground %}--qr-bg: {{ landingBackground }};{% endif %}
        {% if landingForeground %}--qr-fg: {{ landingForeground }};{% endif %}
        {% if landingContrast %}--qr-contrast-on-primary: {{ landingContrast }};{% endif %}
        {% if heroStart %}--qr-hero-grad-start: {{ heroStart }};{% endif %}
        {% if heroEnd %}
          --qr-hero-grad-end: {{ heroEnd }};
        {% elseif landingPrimary %}
          --qr-hero-grad-end: {{ landingPrimary }};
        {% endif %}
      }
    </style>
  {% endif %}
{% endblock %}

{% block body %}
  {% set eventConfig = config|default({}) %}
  {% set heroSubtitleSource = event.description|default(null) %}
  {% set heroCommentSource = eventConfig.inviteText|default(null) %}
  {% set heroSubtitleHtml = heroSubtitleSource ? heroSubtitleSource|uikitify : null %}
  {% set heroCommentHtml = heroCommentSource ? heroCommentSource|uikitify : null %}
  {% set heroSubtitleStory = heroSubtitleHtml is not null and (heroSubtitleSource matches '~</?h[2-6]~i' or heroSubtitleSource matches '/<p/i' or heroSubtitleSource|striptags|length > 180) %}
  {% set heroCommentStory = heroCommentHtml is not null and (heroCommentSource matches '~</?h[2-6]~i' or heroCommentSource matches '/<p/i' or heroCommentSource|striptags|length > 180) %}
  <section class="uk-section uk-section-large uk-text-center">
    <div class="uk-container uk-container-small">
      {{ block('marketing_event_title') }}
      {{ block('marketing_event_schedule') }}
      <div class="uk-margin-large-top">
        {% if start %}
          <div id="event-countdown"
               class="uk-heading-medium uk-text-bold"
               data-start="{{ start|date('c') }}"></div>
        {% endif %}
        {{ block('marketing_event_cta') }}
      </div>
      {{ block('marketing_event_story') }}
      {{ block('marketing_event_teaser') }}
    </div>
  </section>
{% endblock %}

{% block marketing_event_title %}
  {% set eventConfig = eventConfig|default(config|default({})) %}
  {% set heroTitle = eventConfig.pageTitle|default(event.name) %}
  {% set hasHeroSubtitle = heroSubtitleHtml is not null and not heroSubtitleStory %}
  {% set hasHeroComment = heroCommentHtml is not null and not heroCommentStory %}
  {% set rawLogo = eventConfig.logoPath|default('/logo-160.svg') %}
  {% set hasLogo = rawLogo is not empty %}
  {% if hasLogo %}
    {% if rawLogo matches '/^https?:\\/\\//i' %}
      {% set logoSrc = rawLogo %}
    {% else %}
      {% set logoSrc = basePath ~ rawLogo %}
    {% endif %}
  {% endif %}
  <div class="marketing-event-hero uk-flex uk-flex-column uk-flex-middle uk-text-center">
    {% if hasLogo %}
      <img class="marketing-event-hero__logo" src="{{ logoSrc }}" alt="{{ heroTitle }}" loading="lazy">
    {% endif %}
    <span class="qr-badge pill pill--soft">Bald verfügbar</span>
    <h1 class="marketing-event-hero__title uk-heading-medium uk-margin-small-top">{{ heroTitle }}</h1>
    {% if hasHeroSubtitle %}
      <div class="marketing-event-hero__subtitle uk-text-lead uk-margin-small-top">{{ heroSubtitleHtml|raw }}</div>
    {% endif %}
    {% if hasHeroComment %}
      <div class="marketing-event-hero__comment uk-text-meta">{{ heroCommentHtml|raw }}</div>
    {% endif %}
  </div>
{% endblock %}

{% block marketing_event_story %}
  {% set hasStorySubtitle = heroSubtitleHtml is not null and heroSubtitleStory %}
  {% set hasStoryComment = heroCommentHtml is not null and heroCommentStory %}
  {% if hasStorySubtitle or hasStoryComment %}
    <div class="marketing-event-story uk-text-left uk-margin-large-top">
      {% if hasStorySubtitle %}
        {{ heroSubtitleHtml|raw }}
      {% endif %}
      {% if hasStoryComment %}
        {{ heroCommentHtml|raw }}
      {% endif %}
    </div>
  {% endif %}
{% endblock %}

{% block marketing_event_schedule %}
  {% if start or end %}
    <div class="marketing-event-schedule">
      {% if start %}
        <p class="uk-text-lead uk-margin-small">Unser Event startet am <strong>{{ start|format_datetime(pattern="dd.MM.yyyy 'um' HH:mm 'Uhr'", locale='de') }}</strong>.</p>
      {% endif %}
      {% if end %}
        <p class="uk-text-muted">Geplantes Ende: {{ end|format_datetime(pattern="dd.MM.yyyy 'um' HH:mm 'Uhr'", locale='de') }}</p>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}

{% block marketing_event_cta %}
  <div class="uk-margin-medium-top">
    <a class="uk-button uk-button-primary uk-margin-small-right" href="{{ basePath }}/kontakt">Jetzt informieren</a>
    <a class="uk-button uk-button-default" href="{{ basePath }}/newsletter">Erinnerung erhalten</a>
  </div>
{% endblock %}

{% block marketing_event_teaser %}
  {% if not event.description and not heroCommentHtml %}
    <div class="marketing-event-teaser">
      <p class="uk-margin-large-top uk-text-large">Bereite dein Team auf ein Quiz voller Energie, Rätsel und Live-Spannung vor.</p>
    </div>
  {% endif %}
{% endblock %}

{% block scripts %}
  {% if start %}
    <script>
      (function countdown() {
        const el = document.getElementById('event-countdown');
        if (!el) {
          return;
        }
        const target = new Date(el.dataset.start);
        if (Number.isNaN(target.getTime())) {
          el.removeAttribute('data-start');
          return;
        }
        function update() {
          const now = new Date();
          const diff = target.getTime() - now.getTime();
          if (diff <= 0) {
            el.textContent = 'Es geht gleich los!';
            return;
          }
          const totalSeconds = Math.floor(diff / 1000);
          const days = Math.floor(totalSeconds / 86400);
          const hours = Math.floor((totalSeconds % 86400) / 3600);
          const minutes = Math.floor((totalSeconds % 3600) / 60);
          const seconds = totalSeconds % 60;
          el.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }
        update();
        setInterval(update, 1000);
      })();
    </script>
  {% endif %}
{% endblock %}
