{% set appearanceData = appearance|default(design.appearance|default({})) %}
{% set appearanceColors = appearanceData.colors|default({}) %}
{% set appearanceVars = appearanceData.variables|default({}) %}
{% set marketingSchemes = marketingSchemes|default({}) %}

{% set cssVars = [] %}
{% for key, value in appearanceColors %}
  {% if value %}
    {% set cssVars = cssVars|merge(['--appearance-color-' ~ (key|replace({'_': '-'})|lower) ~ ': ' ~ value]) %}
  {% endif %}
{% endfor %}
{% for key, value in appearanceVars %}
  {% if value %}
    {% set cssVars = cssVars|merge(['--appearance-var-' ~ (key|replace({'_': '-'})|lower) ~ ': ' ~ value]) %}
  {% endif %}
{% endfor %}

{% if appearanceColors.primary is defined and appearanceColors.primary %}
  {% set cssVars = cssVars|merge(['--brand-primary: ' ~ appearanceColors.primary]) %}
{% endif %}
{% if appearanceColors.secondary is defined and appearanceColors.secondary %}
  {% set cssVars = cssVars|merge(['--brand-secondary: ' ~ appearanceColors.secondary]) %}
{% endif %}
{% if appearanceColors.accent is defined and appearanceColors.accent %}
  {% set cssVars = cssVars|merge(['--brand-accent: ' ~ appearanceColors.accent]) %}
{% endif %}

{% if appearanceVars.surface is defined and appearanceVars.surface %}
  {% set cssVars = cssVars|merge(['--surface: ' ~ appearanceVars.surface]) %}
{% endif %}
{% if appearanceVars.surfaceMuted is defined and appearanceVars.surfaceMuted %}
  {% set cssVars = cssVars|merge(['--surface-muted: ' ~ appearanceVars.surfaceMuted]) %}
{% endif %}
{% if appearanceVars.textOnSurface is defined and appearanceVars.textOnSurface %}
  {% set cssVars = cssVars|merge([
    '--text-on-surface: ' ~ appearanceVars.textOnSurface,
    '--marketing-text-on-surface: ' ~ appearanceVars.textOnSurface
  ]) %}
{% endif %}
{% if appearanceVars.textOnBackground is defined and appearanceVars.textOnBackground %}
  {% set cssVars = cssVars|merge([
    '--text-on-background: ' ~ appearanceVars.textOnBackground,
    '--marketing-text-on-background: ' ~ appearanceVars.textOnBackground
  ]) %}
{% endif %}
{% if appearanceVars.textOnPrimary is defined and appearanceVars.textOnPrimary %}
  {% set cssVars = cssVars|merge([
    '--text-on-primary: ' ~ appearanceVars.textOnPrimary,
    '--marketing-on-accent: ' ~ appearanceVars.textOnPrimary
  ]) %}
{% endif %}
{% if appearanceVars.topbarLight is defined and appearanceVars.topbarLight %}
  {% set cssVars = cssVars|merge(['--topbar-bg-light: ' ~ appearanceVars.topbarLight]) %}
{% endif %}
{% if appearanceVars.topbarDark is defined and appearanceVars.topbarDark %}
  {% set cssVars = cssVars|merge(['--topbar-bg-dark: ' ~ appearanceVars.topbarDark]) %}
{% endif %}

{% set marketingSchemeKey = appearanceVars.marketingScheme|default(appearanceVars.marketing_scheme|default('')) %}
{% set marketingScheme = marketingSchemeKey and marketingSchemes[marketingSchemeKey] is defined
  ? marketingSchemes[marketingSchemeKey]
  : null
%}

{% set marketingPrimary = appearanceColors.primary is defined and appearanceColors.primary
  ? appearanceColors.primary
  : 'var(--brand-primary)'
%}
{% set marketingAccent = appearanceColors.accent is defined and appearanceColors.accent
  ? appearanceColors.accent
  : (appearanceColors.secondary is defined and appearanceColors.secondary ? appearanceColors.secondary : 'var(--brand-accent)')
%}
{% set marketingSurface = appearanceVars.surface is defined and appearanceVars.surface
  ? appearanceVars.surface
  : 'var(--surface-card)'
%}
{% set marketingMuted = appearanceVars.surfaceMuted is defined and appearanceVars.surfaceMuted
  ? appearanceVars.surfaceMuted
  : 'var(--surface-muted)'
%}
{% set marketingSurfaceMuted = marketingMuted %}
{% set marketingBackground = appearanceColors.background is defined and appearanceColors.background
  ? appearanceColors.background
  : (appearanceVars.background is defined and appearanceVars.background ? appearanceVars.background : 'var(--surface-page)')
%}
{% if marketingScheme %}
  {% set marketingPrimary = marketingScheme.primary %}
  {% set marketingAccent = marketingScheme.accent %}
  {% set marketingSurface = marketingScheme.surface %}
  {% set marketingSurfaceMuted = marketingScheme.surfaceMuted is defined and marketingScheme.surfaceMuted
    ? marketingScheme.surfaceMuted
    : marketingSurface
  %}
  {% set marketingBackground = marketingScheme.background %}
{% endif %}

{% set cssVars = cssVars|merge([
  '--marketing-primary: ' ~ marketingPrimary,
  '--marketing-accent: ' ~ marketingAccent,
  '--marketing-secondary: ' ~ marketingAccent,
  '--marketing-surface: ' ~ marketingSurface,
  '--marketing-surface-muted: ' ~ marketingSurfaceMuted,
  '--marketing-muted: ' ~ marketingMuted,
  '--marketing-background: ' ~ marketingBackground
]) %}

{% if marketingScheme %}
  {% set cssVars = cssVars|merge([
    '--brand-primary: ' ~ marketingPrimary,
    '--brand-accent: ' ~ marketingAccent,
    '--surface: ' ~ marketingSurface,
    '--surface-muted: ' ~ marketingSurfaceMuted,
    '--marketing-on-accent: ' ~ marketingScheme.onAccent,
    '--marketing-text: ' ~ marketingScheme.textOnBackground,
    '--marketing-text-on-surface: ' ~ marketingScheme.textOnSurface,
    '--marketing-text-on-background: ' ~ marketingScheme.textOnBackground,
    '--marketing-text-muted-on-surface: ' ~ marketingScheme.textMutedOnSurface,
    '--marketing-text-muted-on-background: ' ~ marketingScheme.textMutedOnBackground,
    '--marketing-text-on-surface-dark: ' ~ marketingScheme.textOnSurfaceDark,
    '--marketing-text-on-background-dark: ' ~ marketingScheme.textOnBackgroundDark,
    '--marketing-text-muted-on-surface-dark: ' ~ marketingScheme.textMutedOnSurfaceDark,
    '--marketing-text-muted-on-background-dark: ' ~ marketingScheme.textMutedOnBackgroundDark
  ]) %}
{% endif %}

{% if cssVars is not empty %}
  <style>
    html,
    body {
      {{ cssVars|join(';' ~ '\n      ') }};
    }
  </style>
{% endif %}
