{% set appearanceData = appearance|default(design.appearance|default({})) %}
{% set appearanceColors = appearanceData.colors|default({}) %}
{% set appearanceVars = appearanceData.variables|default({}) %}
{% set marketingSchemes = marketingSchemes|default({}) %}

{% set cssVars = [] %}
{% for key, value in appearanceColors %}
  {% if value %}
    {% set cssVars = cssVars|merge(['--appearance-color-' ~ (key|replace({'_': '-'})|lower) ~ ': ' ~ value]) %}
  {% endif %}
{% endfor %}
{% for key, value in appearanceVars %}
  {% if value %}
    {% set cssVars = cssVars|merge(['--appearance-var-' ~ (key|replace({'_': '-'})|lower) ~ ': ' ~ value]) %}
  {% endif %}
{% endfor %}

{% if appearanceColors.primary is defined and appearanceColors.primary %}
  {% set cssVars = cssVars|merge(['--brand-primary: ' ~ appearanceColors.primary]) %}
{% endif %}
{% if appearanceColors.secondary is defined and appearanceColors.secondary %}
  {% set cssVars = cssVars|merge(['--brand-secondary: ' ~ appearanceColors.secondary]) %}
{% endif %}
{% if appearanceColors.accent is defined and appearanceColors.accent %}
  {% set cssVars = cssVars|merge(['--brand-accent: ' ~ appearanceColors.accent]) %}
{% endif %}

{% if appearanceVars.surface is defined and appearanceVars.surface %}
  {% set cssVars = cssVars|merge(['--surface: ' ~ appearanceVars.surface]) %}
{% endif %}
{% if appearanceVars.surfaceMuted is defined and appearanceVars.surfaceMuted %}
  {% set cssVars = cssVars|merge(['--surface-muted: ' ~ appearanceVars.surfaceMuted]) %}
{% endif %}
{% set textOnSurfaceValue = appearanceVars.textOnSurface
  |default(appearanceVars.text_on_surface
  |default(appearanceColors.textOnSurface
  |default(appearanceColors.text_on_surface
  |default(''))))
%}
{% if textOnSurfaceValue %}
  {% set cssVars = cssVars|merge([
    '--text-on-surface: ' ~ textOnSurfaceValue,
    '--marketing-text-on-surface: ' ~ textOnSurfaceValue
  ]) %}
{% endif %}
{% set textOnBackgroundValue = appearanceVars.textOnBackground
  |default(appearanceVars.text_on_background
  |default(appearanceColors.textOnBackground
  |default(appearanceColors.text_on_background
  |default(''))))
%}
{% if textOnBackgroundValue %}
  {% set cssVars = cssVars|merge([
    '--text-on-background: ' ~ textOnBackgroundValue,
    '--marketing-text-on-background: ' ~ textOnBackgroundValue
  ]) %}
{% endif %}
{% set textOnPrimaryValue = appearanceVars.textOnPrimary
  |default(appearanceVars.text_on_primary
  |default(appearanceColors.textOnPrimary
  |default(appearanceColors.text_on_primary
  |default(''))))
%}
{% if textOnPrimaryValue %}
  {% set cssVars = cssVars|merge([
    '--text-on-primary: ' ~ textOnPrimaryValue,
    '--marketing-on-accent: ' ~ textOnPrimaryValue
  ]) %}
{% endif %}
{% if appearanceVars.topbarLight is defined and appearanceVars.topbarLight %}
  {% set cssVars = cssVars|merge([
    '--marketing-topbar-light: ' ~ appearanceVars.topbarLight,
    '--qr-landing-topbar-bg-light: ' ~ appearanceVars.topbarLight
  ]) %}
{% endif %}
{% if appearanceVars.topbarDark is defined and appearanceVars.topbarDark %}
  {% set cssVars = cssVars|merge([
    '--marketing-topbar-dark: ' ~ appearanceVars.topbarDark,
    '--qr-landing-topbar-bg-dark: ' ~ appearanceVars.topbarDark
  ]) %}
{% endif %}

{% set designConfig = design.config|default({}) %}
{% set designColors = designConfig.colors|default({}) %}

{% set marketingSchemeKey = appearanceVars.marketingScheme
  |default(appearanceVars.marketing_scheme
  |default(designColors.marketingScheme
  |default(designColors.marketing_scheme
  |default('')))) %}
{% set marketingScheme = marketingSchemeKey and marketingSchemes[marketingSchemeKey] is defined
  ? marketingSchemes[marketingSchemeKey]
  : null
%}

{% set marketingPrimary = appearanceColors.primary is defined and appearanceColors.primary
  ? appearanceColors.primary
  : 'var(--brand-primary)'
%}
{% set marketingAccent = appearanceColors.accent is defined and appearanceColors.accent
  ? appearanceColors.accent
  : (appearanceColors.secondary is defined and appearanceColors.secondary ? appearanceColors.secondary : 'var(--brand-accent)')
%}
{% set marketingSurface = appearanceVars.surface is defined and appearanceVars.surface
  ? appearanceVars.surface
  : 'var(--surface-card)'
%}
{% set marketingMuted = appearanceVars.surfaceMuted is defined and appearanceVars.surfaceMuted
  ? appearanceVars.surfaceMuted
  : 'var(--surface-muted)'
%}
{% set marketingSurfaceMuted = marketingMuted %}
{% set marketingBackground = appearanceColors.background is defined and appearanceColors.background
  ? appearanceColors.background
  : (appearanceVars.background is defined and appearanceVars.background ? appearanceVars.background : 'var(--surface-page)')
%}
{% if marketingScheme %}
  {% set marketingPrimary = marketingScheme.primary %}
  {% set marketingAccent = marketingScheme.accent %}
  {% set marketingSurface = marketingScheme.surface %}
  {% set marketingSurfaceMuted = marketingScheme.surfaceMuted is defined and marketingScheme.surfaceMuted
    ? marketingScheme.surfaceMuted
    : marketingSurface
  %}
  {% set marketingBackground = marketingScheme.background %}
{% endif %}

{% set cssVars = cssVars|merge([
  '--marketing-primary: ' ~ marketingPrimary,
  '--marketing-accent: ' ~ marketingAccent,
  '--marketing-secondary: ' ~ marketingAccent,
  '--marketing-surface: ' ~ marketingSurface,
  '--marketing-surface-muted: ' ~ marketingSurfaceMuted,
  '--marketing-muted: ' ~ marketingMuted,
  '--marketing-background: ' ~ marketingBackground
]) %}

{% if marketingScheme %}
  {% set cssVars = cssVars|merge([
    '--surface: ' ~ marketingScheme.surface,
    '--surface-muted: ' ~ marketingSurfaceMuted,
    '--text-on-surface: ' ~ marketingScheme.textOnSurface,
    '--text-on-background: ' ~ marketingScheme.textOnBackground,
    '--text-on-primary: ' ~ marketingScheme.onAccent,
    '--marketing-on-accent: ' ~ marketingScheme.onAccent,
    '--marketing-text: ' ~ marketingScheme.textOnBackground,
    '--marketing-text-on-surface: ' ~ marketingScheme.textOnSurface,
    '--marketing-text-on-background: ' ~ marketingScheme.textOnBackground,
    '--marketing-text-muted-on-surface: ' ~ marketingScheme.textMutedOnSurface,
    '--marketing-text-muted-on-background: ' ~ marketingScheme.textMutedOnBackground,
    '--marketing-text-on-surface-dark: ' ~ marketingScheme.textOnSurfaceDark,
    '--marketing-text-on-background-dark: ' ~ marketingScheme.textOnBackgroundDark,
    '--marketing-text-muted-on-surface-dark: ' ~ marketingScheme.textMutedOnSurfaceDark,
    '--marketing-text-muted-on-background-dark: ' ~ marketingScheme.textMutedOnBackgroundDark
  ]) %}
  {% set marketingExtraVars = {
    marketingInk: 'ink',
    surfaceGlass: 'surface-glass',
    surfaceGlassDark: 'surface-glass-dark',
    surfaceAccentSoft: 'surface-accent-soft',
    borderLight: 'border-light',
    ringStrong: 'ring-strong',
    ringStrongDark: 'ring-strong-dark',
    overlaySoft: 'overlay-soft',
    overlayStrong: 'overlay-strong',
    overlayHero: 'overlay-hero',
    shadowSoft: 'shadow-soft',
    shadowDark: 'shadow-dark',
    shadowPanel: 'shadow-panel',
    shadowCardBase: 'shadow-card-base',
    shadowCardSoftBase: 'shadow-card-soft-base',
    shadowCard: 'shadow-card',
    shadowAccent: 'shadow-accent',
    shadowCardSoft: 'shadow-card-soft',
    shadowCardHover: 'shadow-card-hover',
    shadowHeroMockup: 'shadow-hero-mockup',
    shadowPill: 'shadow-pill',
    shadowCallout: 'shadow-callout',
    shadowStat: 'shadow-stat',
    shadowStatAccent: 'shadow-stat-accent',
    fontStack: 'font-stack',
    headingFontStack: 'heading-font-stack',
    headingWeight: 'heading-weight',
    headingLetterSpacing: 'heading-letter-spacing',
    headingLineHeight: 'heading-line-height',
    cardRadius: 'card-radius',
    buttonPrimaryBg: 'button-primary-bg',
    buttonPrimaryText: 'button-primary-text',
    buttonPrimaryBorderColor: 'button-primary-border-color',
    buttonPrimaryHoverBg: 'button-primary-hover-bg',
    buttonPrimaryFocusBg: 'button-primary-focus-bg',
    buttonPrimaryActiveBg: 'button-primary-active-bg',
    buttonSecondaryBg: 'button-secondary-bg',
    buttonSecondaryText: 'button-secondary-text',
    buttonSecondaryBorderColor: 'button-secondary-border-color',
    buttonSecondaryHoverBg: 'button-secondary-hover-bg',
    linkContrastLight: 'link-contrast-light',
    linkContrastDark: 'link-contrast-dark',
    topbarTextContrastLight: 'topbar-text-contrast-light',
    topbarTextContrastDark: 'topbar-text-contrast-dark',
    topbarDropBgContrastLight: 'topbar-drop-bg-contrast-light',
    topbarDropBgContrastDark: 'topbar-drop-bg-contrast-dark',
    topbarBtnBorderContrastLight: 'topbar-btn-border-contrast-light',
    topbarBtnBorderContrastDark: 'topbar-btn-border-contrast-dark',
    topbarFocusRingContrastLight: 'topbar-focus-ring-contrast-light',
    topbarFocusRingContrastDark: 'topbar-focus-ring-contrast-dark',
    danger500: 'danger-500',
    danger600: 'danger-600',
    white: 'white',
    black: 'black',
    blackRgb: 'black-rgb'
  } %}
  {% for schemeKey, cssKey in marketingExtraVars %}
    {% if marketingScheme[schemeKey] is defined and marketingScheme[schemeKey] %}
      {% set cssVars = cssVars|merge(['--marketing-' ~ cssKey ~ ': ' ~ marketingScheme[schemeKey]]) %}
    {% endif %}
  {% endfor %}
  {% if marketingScheme.surfaceDark is defined %}
    {% set cssVars = cssVars|merge([
      '--surface-dark: ' ~ marketingScheme.surfaceDark,
      '--marketing-surface-dark: ' ~ marketingScheme.surfaceDark
    ]) %}
  {% endif %}
  {% if marketingScheme.surfaceMutedDark is defined %}
    {% set cssVars = cssVars|merge([
      '--surface-muted-dark: ' ~ marketingScheme.surfaceMutedDark,
      '--marketing-surface-muted-dark: ' ~ marketingScheme.surfaceMutedDark
    ]) %}
  {% endif %}
  {% if marketingScheme.backgroundDark is defined %}
    {% set cssVars = cssVars|merge(['--marketing-background-dark: ' ~ marketingScheme.backgroundDark]) %}
  {% endif %}
{% endif %}

{% if cssVars is not empty %}
  <style>
    html[data-namespace="{{ normalizedNamespace }}"] {
      {{ cssVars|join(';' ~ '\n      ') }};
    }
  </style>
{% endif %}
