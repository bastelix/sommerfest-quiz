{% extends 'layout.twig' %}

{% block title %}Login{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ basePath }}/css/main.css">
  <link rel="stylesheet" href="{{ basePath }}/css/dark.css" media="all">
  <link rel="stylesheet" href="{{ basePath }}/css/highcontrast.css">
{% endblock %}

{% block body_class %}uk-padding{% endblock %}

{% block body %}
  {% embed 'topbar.twig' %}{% endembed %}
<div class="uk-container uk-flex uk-flex-center uk-margin-large-top">
  <div class="uk-width-1-1@s uk-width-1-2@m uk-width-1-3@l">
    <div class="uk-width-1-1 uk-margin-auto uk-card qr-card uk-card-body uk-box-shadow-large">
          <h3 class="uk-card-title uk-text-center">Login</h3>
          {% if reset_success %}
          <div class="uk-alert-success" uk-alert>
            <p>Passwort erfolgreich ge√§ndert. Bitte melde dich an.</p>
          </div>
          {% endif %}
          {% if error %}
          <div class="uk-alert-danger" uk-alert>
            {% if inactive %}
            <p>Account noch nicht freigeschaltet.</p>
            {% elseif unknown %}
            <p>Benutzer nicht gefunden.</p>
            {% else %}
            <p>Passwort falsch.</p>
            {% endif %}
          </div>
          {% endif %}
          <form method="post" action="{{ basePath }}/login">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="uk-margin">
              <div class="uk-inline uk-width-1-1">
                <span class="uk-form-icon" uk-icon="icon: user"></span>
                <input class="uk-input uk-form-large" type="text" name="username" id="username" placeholder="Benutzername" required>
              </div>
            </div>
            <div class="uk-margin">
              <div class="uk-inline uk-width-1-1">
                <span class="uk-form-icon" uk-icon="icon: lock"></span>
                <input class="uk-input uk-form-large" type="password" name="password" id="password" placeholder="Passwort" required>
              </div>
            </div>
            <div class="uk-margin">
              <button class="uk-button uk-button-primary uk-button-large uk-width-1-1">Login</button>
            </div>
            <div class="uk-margin uk-text-center">
              <a href="{{ basePath }}/password/reset/request">Passwort vergessen?</a>
            </div>
            {% if registration_allowed %}
            <div class="uk-margin uk-text-center">
              <a href="{{ basePath }}/register">Registrieren</a>
            </div>
            {% endif %}
          </form>
          {% if google_client_id %}
          <div class="uk-margin uk-text-center">
            <hr class="uk-divider-icon">
          </div>
          <div id="googleSigninError" class="uk-alert-danger" uk-alert hidden>
            <p id="googleSigninErrorText"></p>
          </div>
          <div id="google-signin-btn" class="uk-flex uk-flex-center uk-margin"></div>
          {% endif %}
      </div>
      {% if version %}
      <div class="uk-text-center uk-text-meta uk-margin-small-top">Version {{ version }}</div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="{{ basePath }}/js/custom-icons.js"></script>
  <script src="{{ basePath }}/js/storage.js"></script>
  {% if google_client_id %}
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    (function () {
      var basePath = '{{ basePath }}';
      var clientId = '{{ google_client_id|e('js') }}';
      function initGoogle() {
        if (typeof google === 'undefined' || !google.accounts) {
          return setTimeout(initGoogle, 100);
        }
        google.accounts.id.initialize({
          client_id: clientId,
          callback: handleGoogleResponse
        });
        var container = document.getElementById('google-signin-btn');
        if (container) {
          google.accounts.id.renderButton(container, {
            theme: 'outline',
            size: 'large',
            width: container.offsetWidth || 300,
            text: 'signin_with',
            locale: 'de'
          });
        }
      }
      function handleGoogleResponse(response) {
        var errorBox = document.getElementById('googleSigninError');
        var errorText = document.getElementById('googleSigninErrorText');
        if (errorBox) errorBox.hidden = true;
        fetch(basePath + '/auth/google', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'fetch'
          },
          credentials: 'same-origin',
          body: JSON.stringify({ credential: response.credential })
        })
          .then(function (res) { return res.json().then(function (data) { return { status: res.status, data: data }; }); })
          .then(function (result) {
            if (result.data.redirect) {
              window.location.href = result.data.redirect;
            } else {
              var msg = 'Anmeldung fehlgeschlagen.';
              if (result.data.error === 'inactive') msg = 'Account noch nicht freigeschaltet.';
              if (result.data.error === 'unknown') msg = 'Kein Konto mit dieser E-Mail-Adresse gefunden.';
              if (errorText) errorText.textContent = msg;
              if (errorBox) errorBox.hidden = false;
            }
          })
          .catch(function () {
            if (errorText) errorText.textContent = 'Verbindungsfehler. Bitte erneut versuchen.';
            if (errorBox) errorBox.hidden = false;
          });
      }
      initGoogle();
    })();
  </script>
  {% endif %}
{% endblock %}
