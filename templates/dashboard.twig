{% extends 'layout.twig' %}

{% set dashboardTheme = dashboard.theme|default(config.dashboardTheme|default('light')) %}

{% block title %}{{ event.name }} · Live-Dashboard{% endblock %}

{% block head %}
  {{ parent() }}
  <link rel="stylesheet" href="{{ basePath }}/css/main.css">
  <style>
    :root {
      --dashboard-accent: {{ config.buttonColor|default('#1e87f0') }};
    }
    .dashboard-modules .uk-card {
      border-top: 3px solid var(--dashboard-accent);
    }
    .dashboard-status {
      align-items: center;
      gap: 0.5rem;
    }
    .dashboard-info {
      border-left: 4px solid var(--dashboard-accent);
      padding-left: 1rem;
    }
    .dashboard-media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 0.75rem;
    }
    .dashboard-qr-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.75rem;
    }
    .dashboard-qr-card img {
      width: 100%;
      height: auto;
    }
    .dashboard-qr-link {
      word-break: break-word;
      margin-top: 0.5rem;
      font-size: 0.875rem;
    }
    .dashboard-qr-missing {
      font-size: 0.875rem;
    }
    body[data-theme='dark'] .dashboard-page {
      background-color: var(--color-bg);
    }
    body[data-theme='dark'] .dashboard-status,
    body[data-theme='dark'] .dashboard-leader__label,
    body[data-theme='dark'] .dashboard-leader__meta,
    body[data-theme='dark'] .dashboard-qr-link,
    body[data-theme='dark'] .dashboard-qr-missing {
      color: rgba(255, 255, 255, 0.72);
    }
    body[data-theme='dark'] .dashboard-status .uk-button {
      border-color: rgba(255, 255, 255, 0.25);
      color: var(--color-text);
    }
    body[data-theme='dark'] .dashboard-status .uk-button:hover,
    body[data-theme='dark'] .dashboard-status .uk-button:focus-visible {
      border-color: var(--dashboard-accent);
      color: var(--dashboard-accent);
    }
    body[data-theme='dark'] .dashboard-leader__label {
      color: rgba(255, 255, 255, 0.6);
    }
    body[data-theme='dark'] .dashboard-leader__summary {
      border-left-color: var(--dashboard-accent);
    }
    body[data-theme='dark'] .dashboard-modules .uk-card {
      border-color: rgba(255, 255, 255, 0.12);
    }
    body[data-theme='dark'] .dashboard-page .uk-heading-bullet::before {
      background: rgba(255, 255, 255, 0.4);
    }
  </style>
{% endblock %}

{% block body_theme %}{{ dashboardTheme == 'dark' ? 'dark' : 'light' }}{% endblock %}

{% block body_class %}dashboard-page{% if dashboardTheme != 'dark' %} uk-background-muted{% endif %}{% endblock %}

{% block body %}
  <div class="uk-container uk-container-large uk-padding-small">
    <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-medium-top" data-dashboard-header>
      <div>
        <h1 class="uk-heading-bullet uk-margin-remove">{{ event.name }}</h1>
        {% if dashboard.visibility.start or dashboard.visibility.end %}
          <div class="uk-text-meta">
            {% if dashboard.visibility.start %}Sichtbar ab {{ dashboard.visibility.start|date('d.m.Y H:i') }}{% endif %}
            {% if dashboard.visibility.start and dashboard.visibility.end %} · {% endif %}
            {% if dashboard.visibility.end %}Bis {{ dashboard.visibility.end|date('d.m.Y H:i') }}{% endif %}
          </div>
        {% endif %}
      </div>
      <div class="dashboard-status uk-flex">
        <span id="dashboardStatusLabel" class="uk-text-meta"></span>
        <button class="uk-button uk-button-default" id="dashboardRefreshBtn" type="button">Aktualisieren</button>
      </div>
    </div>
    {% if not dashboard.active %}
      <div class="uk-alert uk-alert-warning uk-margin">Das Dashboard ist derzeit nicht aktiv.</div>
    {% endif %}
    <div id="dashboardModules" class="dashboard-modules dashboard-grid uk-margin-large-top" data-dashboard-root></div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    window.dashboardConfig = {{ {
      eventUid: event.uid,
      slug: event.slug,
      modules: dashboard.modules,
      refreshInterval: dashboard.refreshInterval,
      infoText: dashboard.infoText,
      mediaItems: dashboard.mediaItems,
      shareToken: dashboard.shareToken,
      variant: dashboard.variant,
      puzzleWordEnabled: config.puzzleWordEnabled,
      active: dashboard.active,
      visibility: dashboard.visibility,
      theme: dashboard.theme
    }|json_encode(constant('JSON_HEX_TAG') b-or constant('JSON_HEX_APOS') b-or constant('JSON_HEX_AMP') b-or constant('JSON_HEX_QUOT'))|raw }};
  </script>
  <script type="module" src="{{ basePath }}/js/event-dashboard.js"></script>
{% endblock %}
