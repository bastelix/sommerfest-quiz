{% extends 'layout.twig' %}

{% block title %}{{ config.pageTitle|default('Modernes Quiz mit UIkit') }}{% endblock %}

{% block head %}
  <meta name="csrf-token" content="{{ csrf_token }}">
  <link rel="stylesheet" href="{{ basePath }}/css/main.css">
  {% set cfg = config is defined ? config : {} %}
  <link rel="stylesheet" href="{{ basePath }}/css/dark.css" media="all">
  <link rel="stylesheet" href="{{ basePath }}/css/highcontrast.css">
  <link rel="stylesheet" href="{{ basePath }}/css/marketing.css">
{% endblock %}

{% block body_class %}index-page uk-padding@m uk-padding-remove-top{% endblock %}

{% block body %}
  {% embed 'topbar.twig' %}
    {% block left %}
      {% if config.randomNames %}
        <button id="teamNameBtn" class="uk-button uk-button-default uk-button-small" type="button" data-placeholder="Teamnamen eingeben">{{ player_name|default('Teamnamen eingeben') }}</button>
      {% endif %}
    {% endblock %}
  {% endembed %}
  <div class="uk-container uk-container-large">
    <h1 class="uk-heading-small uk-heading-medium@m uk-text-center uk-text-light">{{ event.name }}</h1>
    {% if event.description %}
      <p class="uk-text-lead uk-text-center">{{ event.description }}</p>
    {% endif %}
  </div>
  <div class="uk-container uk-width-1-1 uk-width-1-2@s uk-width-2-3@m">
    <div class="uk-card qr-card uk-card-body uk-box-shadow-large uk-margin" uk-scrollspy="cls: uk-animation-fade">
      <div id="quiz-header" class="uk-text-center uk-margin" uk-scrollspy="cls: uk-animation-scale-up; delay: 100">
        <img id="quiz-logo" class="logo-placeholder"
             src="{% if config.logoPath %}{{ basePath ~ config.logoPath }}{% else %}{{ basePath }}/logo-160.svg{% endif %}"
             {% if not config.logoPath %}
             srcset="{{ basePath }}/logo-160.svg 160w, {{ basePath }}/logo-320.svg 320w"
             sizes="(max-width: 600px) 160px, 320px"
             {% endif %}
             alt="Logo" width="160" height="240" loading="lazy">
      </div>
      <progress id="progress" class="uk-progress" value="0" max="1" aria-label="{{ t('quiz_progress') }}" aria-valuenow="0" uk-scrollspy="cls: uk-animation-fade; delay: 200"></progress>
      <span id="question-announcer" class="uk-hidden-visually" aria-live="polite"></span>
      <div id="quiz" uk-scrollspy="cls: uk-animation-slide-bottom-small; delay: 300">
        <select id="catalog-select" class="uk-select">
          {% for cat in catalogs %}
            {% set key = cat.slug ?? cat.uid ?? cat.sort_order ?? cat.id %}
            <option
              value="{{ key }}"
              data-slug="{{ cat.slug|e }}"
              data-sort-order="{{ cat.sort_order ?? cat.id }}"
              data-file="/kataloge/{{ cat.file }}"
              data-letter="{{ cat.raetsel_buchstabe }}"
              data-uid="{{ cat.uid }}"
              data-desc="{{ cat.description ?? cat.beschreibung }}"
              data-comment="{{ cat.comment ?? cat.kommentar }}"
            >
              {{ cat.name ?? cat.slug ?? cat.uid ?? cat.sort_order ?? cat.id }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="{{ basePath }}/js/custom-icons.js" defer></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.7/html5-qrcode.min.js" defer></script>
  <script>
    window.quizConfig = {{ config|json_encode|raw }};
  </script>
  <script>
    window.csrfToken = '{{ csrf_token|e('js') }}';
  </script>
  <script>
    window.sessionPlayerName = {{ player_name|json_encode|raw }};
  </script>
  <script id="catalogs-data" type="application/json">{{ catalogs|json_encode|raw }}</script>
  <script src="{{ basePath }}/js/storage.js"></script>
  <script src="{{ basePath }}/js/session.js"></script>
  <script src="{{ basePath }}/js/name-generator.js" defer></script>
  <script>
    function enforceProfile() {
      const cfg = window.quizConfig || {};
      if (!cfg.randomNames || cfg.QRUser || cfg.QRRestrict) {
        return;
      }
      if (!getStored(STORAGE_KEYS.PLAYER_NAME)) {
        const params = new URLSearchParams(location.search);
        const uidParam = params.get('uid') || params.get('player_uid');
        let url = '/profile?return=' + encodeURIComponent(location.href);
        if (uidParam) {
          url += '&uid=' + encodeURIComponent(uidParam);
        }
        location.replace(url);
      }
    }
    enforceProfile();
  </script>
  <script src="{{ basePath }}/js/quiz.js" defer></script>
  <script src="{{ basePath }}/js/catalog.js" defer></script>
  <script>
    (function () {
      window.catalogInit = false;
      const script = document.querySelector('script[src="{{ basePath }}/js/catalog.js"]');
      if (script) {
        script.addEventListener('load', function () {
          window.catalogInit = true;
        });
      }
      document.addEventListener('DOMContentLoaded', function () {
        if (!window.catalogInit) {
          const warning = document.createElement('div');
          warning.className = 'uk-alert uk-alert-warning uk-text-center';
          warning.textContent = 'Der Katalog konnte nicht geladen werden. Bitte laden Sie die Seite neu oder '
            + 'kontaktieren Sie den Support.';
          document.body.prepend(warning);
        }
      });
    })();
  </script>
  <script src="{{ basePath }}/js/confetti.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js" defer></script>
{% endblock %}
