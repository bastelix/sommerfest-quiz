{% extends 'admin/base.twig' %}
{% set adminLayout = 'standard' %}
{% import 'components/standard_table.twig' as tables %}

{% block title %}{{ t('tab_newsletter_campaigns') }}{% endblock %}

{% block content %}
  {% set activePageNamespace = pageNamespace|default('default') %}
  {% set pageNamespaceQuery = activePageNamespace is not empty ? '?namespace=' ~ activePageNamespace|url_encode : '' %}
  {% set editCampaign = activeCampaign is defined and activeCampaign ? activeCampaign : null %}
      <div class="uk-container uk-container-large">
        <div class="uk-flex uk-flex-between uk-flex-middle uk-padding-small uk-padding-remove-horizontal">
          <h1 class="uk-heading-bullet uk-margin-remove">{{ t('heading_newsletter_campaigns') }}</h1>
          <div class="uk-flex uk-flex-middle uk-margin-small-left">
            {% include 'admin/partials/namespace_badge.twig' with { pageNamespace: activePageNamespace } %}
          </div>
        </div>
      </div>
      <div class="uk-section uk-section-small">
        <div class="uk-container">

          {% set pageNamespaceOptions = available_namespaces|default([]) %}
          {% include 'admin/partials/namespace_select.twig' %}

        {% if error_message is defined and error_message %}
          <div class="uk-alert-danger" uk-alert>
            <a class="uk-alert-close" uk-close></a>
            <p>{{ error_message }}</p>
          </div>
        {% endif %}

        <div class="uk-grid uk-grid-large" uk-grid>
          <div class="uk-width-1-1">
            <div class="uk-card uk-card-default uk-card-body">
              <h2 class="uk-card-title">{{ t('heading_newsletter_campaign_list') }}</h2>
              <p class="uk-text-meta">{{ t('text_newsletter_campaign_intro') }}</p>
              {% set headings = [
                { label: t('label_campaign_name') },
                { label: t('label_campaign_news'), class: 'uk-table-expand' },
                { label: t('label_campaign_status') },
                { label: t('label_campaign_sent_at') },
                { label: t('actions'), class: 'uk-table-shrink uk-text-right' },
              ] %}
              {% set campaignRows %}
                {% for campaign in campaigns %}
                  {% set editBase = basePath ~ '/admin/newsletter-campaigns' ~ pageNamespaceQuery %}
                  {% set editLink = editBase ~ (pageNamespaceQuery ? '&' : '?') ~ 'edit=' ~ campaign.id %}
                  <tr>
                    <td data-title="{{ t('label_campaign_name') }}">{{ campaign.name }}</td>
                    <td data-title="{{ t('label_campaign_news') }}">
                      {% if campaign.newsIds %}
                        <ul class="uk-list uk-list-collapse">
                          {% for newsId in campaign.newsIds %}
                            {% set newsEntry = (newsEntries|filter(n => n.id == newsId)|first) %}
                            <li>{{ newsEntry ? newsEntry.title : '#' ~ newsId }}</li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <span class="uk-text-muted">{{ t('text_campaign_no_news') }}</span>
                      {% endif %}
                    </td>
                    <td data-title="{{ t('label_campaign_status') }}">
                      <span class="uk-label">{{ campaign.status }}</span><br>
                      {% if campaign.providerCampaignId %}
                        <small>{{ t('label_campaign_provider_id') }}: {{ campaign.providerCampaignId }}</small>
                      {% endif %}
                    </td>
                    <td data-title="{{ t('label_campaign_sent_at') }}">
                      {% if campaign.sentAt %}
                        {{ campaign.sentAt|date('d.m.Y H:i') }}
                      {% else %}
                        <span class="uk-text-muted">{{ t('text_campaign_not_sent') }}</span>
                      {% endif %}
                    </td>
                    <td class="uk-table-shrink uk-text-right" data-title="{{ t('actions') }}">
                      <div class="uk-inline">
                        <button
                          class="uk-button uk-button-default uk-button-small"
                          type="button"
                          uk-icon="icon: more; ratio: 0.9"
                          aria-label="{{ t('actions') }}"
                        >
                          <span class="uk-hidden">{{ t('actions') }}</span>
                        </button>
                        <div uk-dropdown="mode: click; pos: bottom-right; offset: 0; container: .admin-page">
                          <ul class="uk-nav uk-dropdown-nav">
                            <li>
                              <a class="uk-button uk-button-link uk-width-1-1 uk-text-left" href="{{ editLink }}">{{ t('button_edit') }}</a>
                            </li>
                            <li>
                              <form method="post" action="{{ basePath }}/admin/newsletter-campaigns/{{ campaign.id }}/send{{ pageNamespaceQuery }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <button class="uk-button uk-button-link uk-width-1-1 uk-text-left" type="submit">{{ t('button_send_campaign') }}</button>
                              </form>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </td>
                  </tr>
                {% else %}
                  <tr>
                    <td colspan="5" class="uk-text-center uk-text-muted">{{ t('text_campaigns_empty') }}</td>
                  </tr>
                {% endfor %}
              {% endset %}
              {{ tables.render(headings, 'newsletterCampaignTableBody', campaignRows) }}
            </div>
          </div>

          <div class="uk-width-1-1">
            <div class="uk-card uk-card-default uk-card-body">
              <h2 class="uk-card-title">{{ editCampaign ? t('heading_edit_campaign') : t('heading_create_campaign') }}</h2>
              <form method="post" action="{{ basePath }}/admin/newsletter-campaigns{{ pageNamespaceQuery }}" class="uk-form-stacked">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                {% if editCampaign %}
                  <input type="hidden" name="id" value="{{ editCampaign.id }}">
                {% endif %}
                <div class="uk-margin">
                  <label class="uk-form-label" for="campaignName">{{ t('label_campaign_name') }}</label>
                  <div class="uk-form-controls">
                    <input class="uk-input" id="campaignName" name="name" type="text" value="{{ editCampaign ? editCampaign.name : '' }}" required>
                  </div>
                </div>
                <div class="uk-margin">
                  <label class="uk-form-label" for="campaignNews">{{ t('label_campaign_news') }}</label>
                  <div class="uk-form-controls">
                    <select class="uk-select" id="campaignNews" name="news_ids[]" multiple size="6">
                      {% for entry in newsEntries %}
                        {% set selected = editCampaign and entry.id in editCampaign.newsIds %}
                        <option value="{{ entry.id }}" {% if selected %}selected{% endif %}>
                          {{ entry.title }} ({{ entry.pageSlug }})
                        </option>
                      {% endfor %}
                    </select>
                    <p class="uk-text-meta uk-margin-small-top">{{ t('text_campaign_news_hint') }}</p>
                  </div>
                </div>
                <div class="uk-margin">
                  <label class="uk-form-label" for="campaignTemplate">{{ t('label_campaign_template') }}</label>
                  <div class="uk-form-controls">
                    <input class="uk-input" id="campaignTemplate" name="template_id" type="text" value="{{ editCampaign ? editCampaign.templateId : '' }}">
                  </div>
                </div>
                <div class="uk-margin">
                  <label class="uk-form-label" for="campaignAudience">{{ t('label_campaign_audience') }}</label>
                  <div class="uk-form-controls">
                    <input class="uk-input" id="campaignAudience" name="audience_id" type="text" value="{{ editCampaign ? editCampaign.audienceId : '' }}">
                  </div>
                </div>
                <div class="uk-margin">
                  <label class="uk-form-label" for="campaignStatus">{{ t('label_campaign_status') }}</label>
                  <div class="uk-form-controls">
                    <select class="uk-select" id="campaignStatus" name="status">
                      {% set currentStatus = editCampaign ? editCampaign.status : 'draft' %}
                      <option value="draft" {% if currentStatus == 'draft' %}selected{% endif %}>{{ t('label_status_draft') }}</option>
                      <option value="ready" {% if currentStatus == 'ready' %}selected{% endif %}>{{ t('label_status_ready') }}</option>
                      <option value="sent" {% if currentStatus == 'sent' %}selected{% endif %}>{{ t('label_status_sent') }}</option>
                    </select>
                  </div>
                </div>
                <div class="uk-margin">
                  <label class="uk-form-label" for="campaignSchedule">{{ t('label_campaign_scheduled_for') }}</label>
                  <div class="uk-form-controls">
                    <input class="uk-input" id="campaignSchedule" name="scheduled_for" type="datetime-local" value="{{ editCampaign and editCampaign.scheduledFor ? editCampaign.scheduledFor|date('Y-m-d\\TH:i') : '' }}">
                  </div>
                </div>
                <div class="uk-margin">
                  <button class="uk-button uk-button-primary" type="submit">
                    {{ editCampaign ? t('button_save_campaign') : t('button_create_campaign') }}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
{% endblock %}

{% block scripts %}
  <script src="{{ basePath }}/js/storage.js"></script>
  <script type="module" src="{{ basePath }}/js/admin.js"></script>
{% endblock %}
