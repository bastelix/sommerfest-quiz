{% extends 'admin/base.twig' %}
{% set includeMarketingThemeVars = true %}

{% block title %}{{ t('heading_wiki') }}{% endblock %}

{% block admin_head %}
  <script>
    window.profileVars = {
      NAME: {{ tenant.imprint_name|default('')|json_encode|raw }},
      STREET: {{ tenant.imprint_street|default('')|json_encode|raw }},
      ZIP: {{ tenant.imprint_zip|default('')|json_encode|raw }},
      CITY: {{ tenant.imprint_city|default('')|json_encode|raw }},
      EMAIL: {{ tenant.imprint_email|default('')|json_encode|raw }}
    };
  </script>
{% endblock %}

{% block content %}
      <div class="uk-container uk-container-large">
        <h1 class="uk-heading-bullet">{{ t('heading_wiki') }}</h1>
      </div>
      <div class="uk-container uk-container-large">
        {% set activePageNamespace = pageNamespace|default('default') %}
        {% set pageNamespaceOptions = available_namespaces|default([]) %}
        {% include 'admin/partials/namespace_select.twig' %}


        {% if pages|default([]) is empty %}
          <div class="uk-alert uk-alert-warning">{{ t('text_no_marketing_pages') }}</div>
        {% else %}
          {% set initialWikiPageId = selectedWikiPageId|default(pages|first.id|default(0)) %}
          <div
            class="wiki-manager"
            data-wiki-manager
            data-base-path="{{ basePath }}"
            data-namespace="{{ activePageNamespace|e('html_attr') }}"
            data-pages="{{ pages|json_encode|e('html_attr') }}"
            data-selected-page-id="{{ initialWikiPageId }}"
          >
            <div class="uk-alert uk-alert-primary" data-wiki-feedback hidden role="status"></div>
            <div class="uk-grid-small uk-flex-middle uk-flex-wrap" uk-grid>
              <div class="uk-width-1-1 uk-width-expand@m">
                <label class="uk-form-label" for="wikiPageSelect">{{ t('label_wiki_marketing_page') }}</label>
                <div class="uk-form-controls">
                  <select id="wikiPageSelect" class="uk-select" data-wiki-page-select>
                    {% for page in pages %}
                      {% set pageLabel = page.title is not empty ? page.title : page.slug|replace({'-': ' '})|title %}
                      <option
                        value="{{ page.id }}"
                        data-slug="{{ page.slug }}"
                        {% if page.id == initialWikiPageId %}selected{% endif %}
                      >
                        {{ pageLabel }} ({{ page.slug }})
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="uk-width-auto uk-margin-small-top uk-margin-remove-top@m">
                <span class="uk-text-meta" data-wiki-selected-slug></span>
              </div>
            </div>
            <div
              class="uk-card uk-card-default uk-card-body uk-margin"
              data-page-namespace-manager
              data-pages="{{ page_namespace_list|json_encode|e('html_attr') }}"
              data-page-select-id="wikiPageSelect"
              data-page-select-key="id"
              data-page-selection-param="pageId"
              data-page-selection-value-key="id"
              data-active-namespace="{{ activePageNamespace|e('html_attr') }}"
              data-success-message="{{ t('notify_wiki_page_moved')|e('html_attr') }}"
              data-error-message="{{ t('error_wiki_namespace_change')|e('html_attr') }}"
            >
              <div class="uk-grid-small uk-flex-middle" uk-grid>
                <div class="uk-width-1-1 uk-width-expand@m">
                  <label class="uk-form-label" for="pageNamespacePerPageSelect">{{ t('label_page_project_namespace') }}</label>
                  <div class="uk-form-controls">
                    <select id="pageNamespacePerPageSelect" class="uk-select" data-page-namespace-select>
                      {% for entry in pageNamespaceOptions %}
                        {% set entryNamespace = entry.namespace|default('') %}
                        {% set entryLabel = entry.label|default('') %}
                        {% set entryIsInactive = entry.is_active is defined and not entry.is_active %}
                        <option value="{{ entryNamespace|e('html_attr') }}">
                          {{ entryNamespace }}
                          {% if entryLabel is not empty %} – {{ entryLabel }}{% endif %}
                          {% if entryIsInactive %} – {{ t('label_inactive') }}{% endif %}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="uk-width-auto uk-text-meta uk-margin-small-top uk-margin-remove-top@m">
                  {{ t('text_page_project_namespace_change') }}
                </div>
              </div>
              <div class="uk-alert uk-alert-primary uk-margin-small-top" data-page-namespace-feedback hidden role="status"></div>
            </div>

            <div data-wiki-tabs hidden>
              <ul class="uk-tab" uk-tab>
                <li class="uk-active"><a href="#">{{ t('heading_wiki_articles') }}</a></li>
                <li><a href="#">{{ t('heading_wiki_settings') }}</a></li>
              </ul>

              <ul class="uk-switcher uk-margin-remove-top">
                <li>
                  <div class="uk-card uk-card-default uk-card-body uk-margin" data-wiki-articles>
                    <div class="uk-flex uk-flex-between uk-flex-middle uk-flex-wrap">
                      <h3 class="uk-card-title uk-margin-remove">{{ t('heading_wiki_articles') }}</h3>
                      <div class="uk-flex uk-flex-middle uk-flex-wrap" style="gap: 8px;">
                        <label class="uk-form-label uk-margin-remove" for="wikiLocaleFilter">Locale</label>
                        <select id="wikiLocaleFilter" class="uk-select uk-form-small" data-wiki-locale-filter>
                          <option value="all">{{ t('option_all') }}</option>
                        </select>
                        <button type="button" class="uk-button uk-button-default" data-wiki-upload>{{ t('action_wiki_import_markdown') }}</button>
                        <input
                          type="file"
                          accept=".md,.markdown,text/markdown"
                          hidden
                          data-wiki-upload-input
                        >
                        <button type="button" class="uk-button uk-button-primary" data-wiki-create>{{ t('action_wiki_create_article') }}</button>
                      </div>
                    </div>
                    <p class="uk-text-meta uk-margin-small">{{ t('text_wiki_articles_hint') }}</p>
                    <div class="uk-alert uk-alert-warning" data-wiki-articles-empty hidden>{{ t('text_wiki_no_articles') }}</div>
                    <div class="uk-overflow-auto admin-table-wrapper">
                      <table class="uk-table uk-table-divider uk-table-small uk-table-hover">
                        <thead>
                          <tr>
                            <th>{{ t('label_title') }}</th>
                            <th>Locale</th>
                            <th>{{ t('label_status') }}</th>
                            <th>{{ t('label_published') }}</th>
                            <th class="uk-table-shrink">{{ t('label_order') }}</th>
                            <th class="uk-table-shrink">{{ t('label_actions') }}</th>
                          </tr>
                        </thead>
                        <tbody data-wiki-article-list>
                          <tr data-wiki-loading-row>
                            <td colspan="6">{{ t('text_loading') }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </li>

                <li>
                  <div class="uk-card uk-card-default uk-card-body uk-margin" data-wiki-settings>
                    <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-small-bottom">
                      <h3 class="uk-card-title uk-margin-remove">{{ t('heading_wiki_settings') }}</h3>
                      <span class="uk-text-meta" data-wiki-settings-updated></span>
                    </div>
                    <form class="uk-form-stacked" data-wiki-settings-form>
                      <div class="uk-margin">
                        <label class="uk-form-label" for="wikiActive">{{ t('label_wiki_activate_menu') }}</label>
                        <div class="uk-form-controls">
                          <label class="uk-form-label uk-flex uk-flex-middle" style="gap: 8px;">
                            <input class="uk-checkbox" type="checkbox" id="wikiActive" data-wiki-active>
                            <span>{{ t('label_wiki_show_article_list') }}</span>
                          </label>
                          <p class="uk-text-meta uk-margin-small-top">
                            {{ t('text_wiki_activate_menu_hint') }}
                          </p>
                        </div>
                      </div>
                      <div class="uk-margin">
                        <label class="uk-form-label">{{ t('label_wiki_menu_label') }}</label>
                        <ul class="uk-tab" uk-tab>
                          <li><a href="#">DE</a></li>
                          <li><a href="#">EN</a></li>
                        </ul>
                        <ul class="uk-switcher uk-margin-small-top">
                          <li>
                            <input class="uk-input" type="text" data-wiki-menu-label-locale="de" maxlength="80" placeholder="{{ t('placeholder_wiki_menu_label_de') }}">
                          </li>
                          <li>
                            <input class="uk-input" type="text" data-wiki-menu-label-locale="en" maxlength="80" placeholder="e.g. Documentation">
                          </li>
                        </ul>
                        <p class="uk-text-meta uk-margin-small-top">{{ t('text_wiki_menu_label_hint') }}</p>
                      </div>
                      <div class="uk-flex uk-flex-right uk-flex-middle" style="gap: 12px;">
                        <button type="submit" class="uk-button uk-button-primary" data-wiki-settings-submit>{{ t('action_save_settings') }}</button>
                      </div>
                    </form>
                  </div>
                </li>
              </ul>
            </div>
          </div>

          <div id="wikiArticleModal" class="uk-modal" uk-modal>
            <div class="uk-modal-dialog uk-modal-body">
              <button class="uk-modal-close-default" type="button" uk-close></button>
              <h2 class="uk-modal-title" data-wiki-modal-title>{{ t('heading_wiki_edit_article') }}</h2>
              <div class="uk-alert uk-alert-danger" data-wiki-article-error hidden></div>
              <form class="uk-form-stacked" data-wiki-article-form>
                <input type="hidden" data-wiki-article-id>
                <div class="uk-grid-small" uk-grid>
                  <div class="uk-width-1-2@m">
                    <div class="uk-margin">
                      <label class="uk-form-label" for="wikiArticleLocale">Locale</label>
                      <div class="uk-form-controls">
                        <input class="uk-input" id="wikiArticleLocale" type="text" data-wiki-article-locale required maxlength="10" placeholder="de">
                      </div>
                    </div>
                  </div>
                  <div class="uk-width-1-2@m">
                    <div class="uk-margin">
                      <label class="uk-form-label" for="wikiArticleStatus">{{ t('label_status') }}</label>
                      <div class="uk-form-controls">
                        <select class="uk-select" id="wikiArticleStatus" data-wiki-article-status>
                          <option value="draft">{{ t('option_status_draft') }}</option>
                          <option value="published">{{ t('option_status_published') }}</option>
                          <option value="archived">{{ t('option_status_archived') }}</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="uk-margin">
                  <label class="uk-form-label" for="wikiArticleTitle">{{ t('label_title') }}</label>
                  <div class="uk-form-controls">
                    <input class="uk-input" id="wikiArticleTitle" type="text" data-wiki-article-title required maxlength="160">
                  </div>
                </div>
                <div class="uk-margin">
                  <label class="uk-form-label" for="wikiArticleSlug">Slug</label>
                  <div class="uk-form-controls">
                    <input class="uk-input" id="wikiArticleSlug" type="text" data-wiki-article-slug required maxlength="120" placeholder="{{ t('placeholder_wiki_slug') }}">
                  </div>
                </div>
                <div class="uk-margin">
                  <label class="uk-form-label" for="wikiArticleExcerpt">{{ t('label_wiki_excerpt') }}</label>
                  <div class="uk-form-controls">
                    <textarea class="uk-textarea" id="wikiArticleExcerpt" rows="3" data-wiki-article-excerpt maxlength="280" placeholder="{{ t('placeholder_wiki_excerpt') }}"></textarea>
                  </div>
                </div>
                <div class="uk-margin">
                  <label class="uk-form-label" for="wikiArticleStart">{{ t('label_wiki_start_document') }}</label>
                  <div class="uk-form-controls">
                    <label class="uk-flex uk-flex-middle" style="gap: 8px;">
                      <input class="uk-checkbox" id="wikiArticleStart" type="checkbox" data-wiki-article-start>
                      <span>{{ t('label_wiki_show_as_start') }}</span>
                    </label>
                    <p class="uk-text-meta uk-margin-small-top">{{ t('text_wiki_start_document_hint') }}</p>
                  </div>
                </div>
                <div class="uk-margin">
                  <label class="uk-form-label" for="wikiArticleContent">{{ t('label_wiki_content_markdown') }}</label>
                  <div class="uk-form-controls">
                    <textarea class="uk-textarea" id="wikiArticleContent" rows="14" data-wiki-article-content placeholder="{{ t('placeholder_wiki_content') }}"></textarea>
                  </div>
                  <p class="uk-text-meta uk-margin-small-top">{{ t('text_wiki_content_hint') }}</p>
                </div>
                <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-top uk-flex-wrap" style="gap: 12px;">
                  <span class="uk-text-meta" data-wiki-article-updated></span>
                  <div class="uk-flex uk-flex-right uk-flex-middle" style="gap: 8px;">
                    <button type="submit" class="uk-button uk-button-primary" data-wiki-article-submit>{{ t('label_save') }}</button>
                    <button type="button" class="uk-button uk-button-default uk-modal-close">{{ t('label_cancel') }}</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        {% endif %}
      </div>
{% endblock %}

{% block scripts %}
  <script>
    window.transWikiSettingsSaved = '{{ t('notify_wiki_settings_saved')|e('js') }}';
    window.transWikiSettingsError = '{{ t('error_wiki_settings_save')|e('js') }}';
    window.transWikiArticleSaved = '{{ t('notify_wiki_article_saved')|e('js') }}';
    window.transWikiArticleError = '{{ t('error_wiki_article_save')|e('js') }}';
    window.transWikiArticleDeleted = '{{ t('notify_wiki_article_deleted')|e('js') }}';
    window.transWikiArticleDeleteConfirm = '{{ t('confirm_wiki_article_delete')|e('js') }}';
    window.transWikiArticleDuplicate = '{{ t('notify_wiki_article_duplicated')|e('js') }}';
    window.transWikiArticleDuplicateError = '{{ t('error_wiki_article_duplicate')|e('js') }}';
    window.transWikiSortSaved = '{{ t('notify_wiki_sort_saved')|e('js') }}';
    window.transWikiSortError = '{{ t('error_wiki_sort_save')|e('js') }}';
    window.transWikiStatusDraft = '{{ t('option_status_draft')|e('js') }}';
    window.transWikiStatusPublished = '{{ t('option_status_published')|e('js') }}';
    window.transWikiStatusArchived = '{{ t('option_status_archived')|e('js') }}';
    window.transWikiLoading = '{{ t('text_loading')|e('js') }}';
    window.transWikiEmpty = '{{ t('text_wiki_no_articles')|e('js') }}';
    window.transWikiArticleImport = '{{ t('notify_wiki_markdown_imported')|e('js') }}';
    window.transWikiArticleImportError = '{{ t('error_wiki_markdown_import')|e('js') }}';
    window.transWikiArticleImportInvalid = '{{ t('error_wiki_select_markdown')|e('js') }}';
    window.transWikiArticleImportNoPage = '{{ t('error_wiki_select_page_first')|e('js') }}';
    window.transWikiArticleStartMarked = '{{ t('notify_wiki_start_marked')|e('js') }}';
    window.transWikiArticleStartRemoved = '{{ t('notify_wiki_start_removed')|e('js') }}';
    window.transWikiArticleStartBadge = '{{ t('label_wiki_start_badge')|e('js') }}';
  </script>
  <script type="module" src="{{ basePath }}/js/admin.js"></script>
  <script type="module" src="{{ basePath }}/js/wiki-admin.js"></script>
{% endblock %}
