{% extends 'admin/base.twig' %}
{% set includeMarketingThemeVars = true %}

{% block title %}{{ t('heading_pages') }}{% endblock %}

{% block admin_head %}
  <link rel="stylesheet" href="{{ basePath }}/css/dark.css" id="admin-dark-css" data-theme-style="dark" media="all">
  <link rel="stylesheet" href="{{ basePath }}/css/highcontrast.css" id="admin-highcontrast-css" data-theme-style="high-contrast">
  {% set activeNamespace = pageNamespace|default('default') %}
  {% set hasNamespaceStyles = activeNamespace is not empty and activeNamespace != 'default' %}
  {% set namespaceSegment = hasNamespaceStyles ? '/' ~ activeNamespace : '' %}
  {% set namespaceTokensVersionsMap = namespaceTokensVersions|default({}) %}
  {% set namespaceTokensQuery = namespaceTokensVersionsMap[activeNamespace]|default(namespaceTokensVersion|default('')) %}
  <link rel="stylesheet" href="{{ basePath }}/css/uikit.min.css" id="preview-uikit-css" data-preview-asset="page-preview" media="all">
  <link rel="stylesheet" href="{{ basePath }}/css/variables.css" id="preview-variables-css" data-preview-asset="page-preview" media="all">
  <link rel="stylesheet" href="{{ basePath }}/css/sections.css" id="preview-sections-css" data-preview-asset="page-preview" media="all">
  <link
    rel="stylesheet"
    href="{{ basePath }}/css{{ namespaceSegment }}/namespace-tokens.css?v={{ namespaceTokensQuery }}"
    data-default-href="{{ basePath }}/css/namespace-tokens.css?v={{ namespaceTokensQuery }}"
    id="preview-namespace-tokens-css"
    data-preview-asset="page-preview"
    media="all"
    onerror="if (this.dataset && this.dataset.defaultHref) { this.onerror = null; this.href = this.dataset.defaultHref; }"
  >
  <link rel="stylesheet" href="{{ basePath }}/css/table.css" id="preview-table-css" data-preview-asset="page-preview" media="all">
  <link rel="stylesheet" href="{{ basePath }}/css/topbar.css" id="preview-topbar-css" data-preview-asset="page-preview" media="all">
  <link rel="stylesheet" href="{{ basePath }}/css/marketing.css" id="preview-marketing-css" data-preview-asset="page-preview" media="all">
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
  <script>
    window.profileVars = {
      NAME: {{ tenant.imprint_name|default('')|json_encode|raw }},
      STREET: {{ tenant.imprint_street|default('')|json_encode|raw }},
      ZIP: {{ tenant.imprint_zip|default('')|json_encode|raw }},
      CITY: {{ tenant.imprint_city|default('')|json_encode|raw }},
      EMAIL: {{ tenant.imprint_email|default('')|json_encode|raw }}
    };
  </script>
  <script>
    window.transPageAction = '{{ t('action_page_transfer')|e('js') }}';
    window.transPageTransferTitle = '{{ t('heading_page_transfer')|e('js') }}';
    window.transPageTransferActionLabel = '{{ t('label_page_transfer_action')|e('js') }}';
    window.transPageTransferNamespaceLabel = '{{ t('label_page_transfer_namespace')|e('js') }}';
    window.transPageTransferCopy = '{{ t('option_page_transfer_copy')|e('js') }}';
    window.transPageTransferMove = '{{ t('option_page_transfer_move')|e('js') }}';
    window.transPageTransferSubmit = '{{ t('button_page_transfer_submit')|e('js') }}';
    window.transPageTransferSelectionError = '{{ t('error_page_transfer_selection')|e('js') }}';
    window.transPageTransferSameNamespace = '{{ t('error_page_transfer_namespace_same')|e('js') }}';
    window.transPageTransferNoTargets = '{{ t('text_page_transfer_no_targets')|e('js') }}';
    window.transPageCopied = '{{ t('notify_page_copied')|e('js') }}';
    window.transPageMoved = '{{ t('notify_page_moved')|e('js') }}';
    window.transPageTransferError = '{{ t('notify_page_transfer_error')|e('js') }}';
    window.transAiPageMissingFields = '{{ t('error_ai_page_missing_fields')|e('js') }}';
    window.transAiPageCreateError = '{{ t('error_ai_page_create')|e('js') }}';
    window.transAiPageUnavailable = '{{ t('error_ai_page_unavailable')|e('js') }}';
    window.transAiPagePromptMissing = '{{ t('error_ai_page_prompt_missing')|e('js') }}';
    window.transAiPagePromptInvalid = '{{ t('error_ai_page_prompt_invalid')|e('js') }}';
    window.transAiPageEmptyResponse = '{{ t('error_ai_page_empty_response')|e('js') }}';
    window.transAiPageInvalidHtml = '{{ t('error_ai_page_invalid_html')|e('js') }}';
    window.transAiPageTimeout = '{{ t('error_ai_page_timeout')|e('js') }}';
    window.transAiPageCreated = '{{ t('notify_ai_page_created')|e('js') }}';
  </script>
  <script>
    window.pageEditorMode = 'blocks';
  </script>
  <script>
    window.pageNamespace = '{{ activeNamespace|e('js') }}';
    window.pageAppearance = {{ appearance|default({})|json_encode(constant('JSON_UNESCAPED_SLASHES') b-or constant('JSON_HEX_TAG') b-or constant('JSON_HEX_APOS') b-or constant('JSON_HEX_AMP') b-or constant('JSON_HEX_QUOT'))|raw }};
    window.pageDesign = {{ design|default({})|json_encode(constant('JSON_UNESCAPED_SLASHES') b-or constant('JSON_HEX_TAG') b-or constant('JSON_HEX_APOS') b-or constant('JSON_HEX_AMP') b-or constant('JSON_HEX_QUOT'))|raw }};
    window.pageDesignConfig = {{ design.config|default({})|json_encode(constant('JSON_UNESCAPED_SLASHES') b-or constant('JSON_HEX_TAG') b-or constant('JSON_HEX_APOS') b-or constant('JSON_HEX_AMP') b-or constant('JSON_HEX_QUOT'))|raw }};
  </script>
  <script type="module" src="{{ basePath }}/js/tiptap-pages.js?v={{ namespaceTokensQuery|default('now'|date('U')) }}"></script>
{% endblock %}

{% block content %}
      <div class="uk-container uk-container-large">
        <h1 class="uk-heading-bullet">{{ t('heading_pages') }}</h1>
        <p class="uk-text-meta uk-margin-small-top">
          {{ t('text_pages_design_defaults_hint') }}
          {% if designUsedDefaults|default(false) %}
            {{ t('text_no_design_overrides') }}
          {% endif %}
        </p>
      </div>
      <div class="uk-container uk-container-large">
        {% set activePageNamespace = pageNamespace|default('default') %}
        {% set pageNamespaceOptions = available_namespaces|default([]) %}
        {% set hasDomainNamespace = hasDomainNamespace is defined
          ? hasDomainNamespace
          : domainNamespace is defined and domainNamespace is not empty %}
        {% include 'admin/partials/namespace_select.twig' %}


        {% set pagesList = pages|default([]) %}
        {% set hasPages = pagesList is not empty %}
        {% set selectedSlug = selectedPageSlug|default('') %}
        {% if selectedSlug == '' and hasPages %}
          {% set selectedSlug = (pagesList|first).slug %}
        {% endif %}
        {% include 'admin/components/page_tree.twig' %}

        {% set excludedLandingSlugs = ['impressum', 'datenschutz', 'faq', 'lizenz'] %}
        <div id="pageFormsContainer" data-selected="{{ selectedSlug }}" data-excluded-landing="{{ excludedLandingSlugs|join(',') }}">
          {% if pagesList is empty %}
            <div class="uk-alert uk-alert-warning pages-empty-alert">{{ t('text_no_marketing_pages') }}</div>
          {% endif %}
          {% for page in pagesList %}
          <form
            class="page-form{% if page.slug != selectedSlug %} uk-hidden{% endif %}"
            data-slug="{{ page.slug }}"
            data-landing="{{ page.slug not in excludedLandingSlugs ? 'true' : 'false' }}"
            data-page-id="{{ page.id }}"
            data-page-type="{{ page.type|default('')|e('html_attr') }}"
          >
            <input type="hidden" id="page_{{ page.slug }}" name="content" value="{{ page.content|e('html_attr') }}">
            <div class="page-editor" data-content="{{ page.content|e('html_attr') }}"></div>
            <div class="uk-margin-top uk-flex uk-flex-middle uk-flex-wrap" data-editor-actions="true" style="gap: 8px;">
              <button class="uk-button uk-button-primary save-page-btn" type="button">{{ t('action_save') }}</button>
              <button class="uk-button uk-button-default preview-link" type="button">{{ t('action_preview') }}</button>
              <div class="uk-inline">
                <button class="uk-button uk-button-default" type="button">{{ t('action_more_actions') }} <span uk-icon="icon: chevron-down; ratio: 0.75"></span></button>
                <div uk-dropdown="mode: click; pos: bottom-right">
                  <ul class="uk-nav uk-dropdown-nav">
                    <li><a class="export-page-btn" href="#">{{ t('action_export_json') }}</a></li>
                    <li>
                      {% set importInputId = 'pageImportInput-' ~ page.slug %}
                      <label class="import-page-btn" for="{{ importInputId|e('html_attr') }}" style="cursor: pointer;">{{ t('action_import_json') }}</label>
                      <input
                        id="{{ importInputId|e('html_attr') }}"
                        class="page-import-input"
                        type="file"
                        accept="application/json,.json,.page.json"
                        style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;"
                      >
                    </li>
                    <li class="uk-nav-divider"></li>
                    <li><a class="delete-page-btn uk-text-danger" href="#">{{ t('action_delete') }}</a></li>
                  </ul>
                </div>
              </div>
              <span class="uk-text-meta" data-page-import-feedback></span>
            </div>
          </form>
          {% endfor %}
        </div>
        <div id="preview-modal" uk-modal>
          <div class="uk-modal-dialog uk-modal-body">
            <h3>{{ t('action_preview') }}</h3>
            <div id="preview-content" data-namespace="{{ pageNamespace|e('html_attr') }}"></div>
            <button class="uk-button uk-button-default uk-modal-close" type="button">{{ t('action_close') }}</button>
          </div>
        </div>
        <div id="createPageModal" uk-modal>
          <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">{{ t('heading_create_new_page') }}</h2>
            <ul uk-tab>
              <li class="uk-active"><a href="#">{{ t('label_empty') }}</a></li>
              <li><a href="#">{{ t('label_import_from_json') }}</a></li>
            </ul>
            <ul class="uk-switcher uk-margin-small-top">
              <li>
            <form id="createPageForm" class="uk-form-stacked">
              <div id="createPageFeedback" class="uk-alert uk-alert-danger" hidden></div>
              <div class="uk-margin">
                <label class="uk-form-label" for="newPageSlug">{{ t('label_slug') }}</label>
                <div class="uk-form-controls">
                  <input class="uk-input" id="newPageSlug" name="slug" type="text" required maxlength="100" placeholder="{{ t('placeholder_new_page_slug') }}">
                </div>
              </div>
              <div class="uk-margin">
                <label class="uk-form-label" for="newPageTitle">{{ t('label_title') }}</label>
                <div class="uk-form-controls">
                  <input class="uk-input" id="newPageTitle" name="title" type="text" required placeholder="{{ t('placeholder_page_title') }}">
                </div>
              </div>
              <div class="uk-margin">
                <label class="uk-form-label" for="newPageContent">{{ t('label_initial_html') }}</label>
                <div class="uk-form-controls">
                  <textarea class="uk-textarea" id="newPageContent" name="content" rows="6" placeholder="&lt;section class=&quot;uk-section&quot;&gt;...&lt;/section&gt;"></textarea>
                </div>
              </div>
              <div class="uk-flex uk-flex-right">
                <button type="submit" class="uk-button uk-button-primary">{{ t('action_create_page') }}</button>
                <button type="button" class="uk-button uk-button-default uk-margin-small-left uk-modal-close">{{ t('action_cancel') }}</button>
              </div>
            </form>
              </li>
              <li>
                <form id="importCreatePageForm" class="uk-form-stacked" enctype="multipart/form-data">
                  <div id="importCreateFeedback" class="uk-alert uk-alert-danger" hidden></div>
                  <div class="uk-margin">
                    <label class="uk-form-label" for="importPageFile">{{ t('label_page_json_file') }}</label>
                    <div class="uk-form-controls">
                      <input class="uk-input" id="importPageFile" name="file" type="file" accept=".json,.page.json,application/json" required>
                    </div>
                    <p class="uk-text-meta uk-margin-small-top">{{ t('text_json_slug_title_hint') }}</p>
                  </div>
                  <div id="importCreatePreview" hidden>
                    <div class="uk-margin">
                      <label class="uk-form-label" for="importPageSlug">{{ t('label_slug') }}</label>
                      <div class="uk-form-controls">
                        <input class="uk-input" id="importPageSlug" name="slug" type="text" maxlength="100" placeholder="{{ t('placeholder_from_json') }}">
                      </div>
                    </div>
                    <div class="uk-margin">
                      <label class="uk-form-label" for="importPageTitle">{{ t('label_title') }}</label>
                      <div class="uk-form-controls">
                        <input class="uk-input" id="importPageTitle" name="title" type="text" placeholder="{{ t('placeholder_from_json') }}">
                      </div>
                    </div>
                    <div class="uk-margin">
                      <span class="uk-text-meta" data-import-create-block-count></span>
                    </div>
                  </div>
                  <div class="uk-flex uk-flex-right">
                    <button type="submit" class="uk-button uk-button-primary">{{ t('action_create_page_from_json') }}</button>
                    <button type="button" class="uk-button uk-button-default uk-margin-small-left uk-modal-close">{{ t('action_cancel') }}</button>
                  </div>
                </form>
              </li>
            </ul>
          </div>
        </div>
        <div id="aiPageModal" uk-modal>
          <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">{{ t('heading_ai_page_create') }}</h2>
            <form id="aiPageForm" class="uk-form-stacked">
              <div class="uk-alert uk-alert-danger" data-ai-page-feedback hidden role="alert"></div>
              <div data-ai-page-progress hidden>
                <div class="uk-card uk-card-default uk-card-small uk-card-body uk-margin">
                  <ul class="uk-list" data-ai-page-log></ul>
                  <div class="uk-text-meta uk-margin-small-top" data-ai-page-elapsed hidden></div>
                </div>
              </div>
              <div class="uk-margin">
                <label class="uk-form-label" for="aiPageSlug">{{ t('label_ai_page_slug') }}</label>
                <div class="uk-form-controls">
                  <input class="uk-input" id="aiPageSlug" name="slug" type="text" required maxlength="100" placeholder="{{ t('placeholder_ai_page_slug') }}">
                </div>
              </div>
              <div class="uk-margin">
                <label class="uk-form-label" for="aiPageTitle">{{ t('label_ai_page_title') }}</label>
                <div class="uk-form-controls">
                  <input class="uk-input" id="aiPageTitle" name="title" type="text" required placeholder="{{ t('placeholder_ai_page_title') }}">
                </div>
              </div>
              <div class="uk-margin">
                <label class="uk-form-label" for="aiPageProblem">{{ t('label_ai_page_problem') }}</label>
                <div class="uk-form-controls">
                  <textarea
                    class="uk-textarea"
                    id="aiPageProblem"
                    name="problem"
                    rows="5"
                    required
                    placeholder="{{ t('placeholder_ai_page_problem') }}"
                  ></textarea>
                </div>
              </div>
              <div class="uk-margin">
                <label class="uk-form-label" for="aiPagePromptTemplate">{{ t('label_ai_page_prompt_template') }}</label>
                <div class="uk-form-controls">
                  <select class="uk-select" id="aiPagePromptTemplate" name="prompt_template_id">
                    <option value="">{{ t('placeholder_ai_page_prompt_template') }}</option>
                    {% for template in prompt_templates|default([]) %}
                      {% set templateId = template.id|default('') %}
                      {% set templateLabel = template.label|default('') %}
                      {% if templateId is not empty and templateLabel is not empty %}
                        <option value="{{ templateId|e('html_attr') }}">{{ templateLabel }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="uk-margin">
                <div class="uk-form-controls">
                  <label>
                    <input class="uk-checkbox" id="aiPageCreateMenuItem" name="create_menu_item" type="checkbox">
                    {{ t('label_create_menu_item') }}
                  </label>
                </div>
              </div>
              <div class="uk-margin" data-ai-page-menu-label hidden>
                <label class="uk-form-label" for="aiPageMenuLabel">{{ t('label_menu_title_optional') }}</label>
                <div class="uk-form-controls">
                  <input class="uk-input" id="aiPageMenuLabel" name="menu_label" type="text" placeholder="{{ t('placeholder_default_page_title') }}">
                </div>
              </div>
              <div class="uk-flex uk-flex-right">
                <button type="submit" class="uk-button uk-button-primary">{{ t('action_ai_page_create') }}</button>
                <button type="button" class="uk-button uk-button-default uk-margin-small-left uk-modal-close">{{ t('button_cancel') }}</button>
              </div>
            </form>
          </div>
        </div>
        <div id="pageTransferModal" uk-modal>
          <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">{{ t('heading_page_transfer') }}</h2>
            <form id="pageTransferForm" class="uk-form-stacked">
              <input type="hidden" id="pageTransferSlug" name="slug" value="">
              <div class="uk-text-meta uk-margin-small-bottom" data-page-transfer-title></div>
              {% if not hasPages %}
                <div class="uk-alert uk-alert-warning uk-margin-small-bottom">
                  Keine Seiten im Namespace.
                </div>
              {% endif %}
              <div class="uk-alert uk-alert-danger" data-page-transfer-feedback hidden></div>
              <div class="uk-margin">
                <label class="uk-form-label" for="pageTransferAction">{{ t('label_page_transfer_action') }}</label>
                <div class="uk-form-controls">
                  <select id="pageTransferAction" class="uk-select" required>
                    <option value="">{{ t('placeholder_select_action') }}</option>
                    <option value="copy">{{ t('option_page_transfer_copy') }}</option>
                    <option value="move">{{ t('option_page_transfer_move') }}</option>
                  </select>
                </div>
              </div>
              <div class="uk-margin">
                <label class="uk-form-label" for="pageTransferNamespace">{{ t('label_page_transfer_namespace') }}</label>
                <div class="uk-form-controls">
                  <select id="pageTransferNamespace" class="uk-select" required>
                    <option value="">{{ t('placeholder_select_namespace') }}</option>
                    {% set transferTargets = available_namespaces|default([]) %}
                    {% if transferTargets is empty %}
                      {% set transferTargets = [{
                        namespace: activePageNamespace,
                        label: null,
                        is_active: true
                      }] %}
                    {% endif %}
                    {% for entry in transferTargets %}
                      {% set entryNamespace = entry.namespace|default('') %}
                      {% set entryLabel = entry.label|default('') %}
                      {% if entryNamespace and entryNamespace != activePageNamespace %}
                        <option value="{{ entryNamespace|e('html_attr') }}">
                          {{ entryNamespace }}
                          {% if entryLabel is not empty %} â€“ {{ entryLabel }}{% endif %}
                        </option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="uk-flex uk-flex-right">
                <button
                  type="submit"
                  class="uk-button uk-button-primary"
                  data-page-transfer-submit
                  {% if not hasPages %}disabled{% endif %}
                >
                  {{ t('button_page_transfer_submit') }}
                </button>
                <button type="button" class="uk-button uk-button-default uk-margin-small-left uk-modal-close">
                  {{ t('action_cancel') }}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
{% endblock %}

{% block scripts %}
  <script type="module" src="{{ basePath }}/js/admin.js"></script>
{% endblock %}
