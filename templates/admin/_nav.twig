{% set groups = [
  {
    items: [
      {
        href: basePath ~ '/admin/dashboard',
        icon: 'home',
        text: t('tab_dashboard'),
        noEvent: true
      },
    ]
  },
  {
    header: t('menu_event_management'),
    items: [
      { href: basePath ~ '/admin/events', icon: 'calendar', text: t('tab_events') },
      { href: basePath ~ '/admin/event/dashboard', icon: 'tv', text: t('tab_event_dashboard') },
      { href: basePath ~ '/admin/event/settings', icon: 'cog', text: t('tab_event_settings') },
      { href: basePath ~ '/admin/username-blocklist', icon: 'lock', text: t('tab_username_settings'), admin: true },
      { href: basePath ~ '/admin/summary', icon: 'table', text: t('tab_summary') },
      { href: basePath ~ '/admin/catalogs', icon: 'database', text: t('tab_catalogs'), roles: ['admin', 'catalog-editor'] },
      { href: basePath ~ '/admin/questions', icon: 'question', text: t('tab_questions') },
      { href: basePath ~ '/admin/teams', icon: 'users', text: t('tab_teams') },
      { href: basePath ~ '/admin/results', icon: 'list', text: t('tab_results') },
      { href: basePath ~ '/admin/statistics', icon: 'signal', text: t('tab_statistics') },
    ]
  },
  {
    header: t('menu_content'),
    items: [
      {
        href: basePath ~ '/admin/media',
        icon: 'image',
        text: t('tab_media'),
        roles: ['admin', 'catalog-editor'],
        noEvent: true
      },
      {
        href: basePath ~ '/admin/rag-chat',
        icon: 'comments',
        text: t('tab_rag_chat'),
        roles: ['admin', 'catalog-editor'],
        noEvent: true
      },
      {
        href: basePath ~ '/admin/pages',
        icon: 'file-edit',
        text: t('tab_pages'),
        admin: true,
        noEvent: true
      },
    ]
  },
  {
    header: t('menu_account'),
    items: [
      { href: basePath ~ '/admin/profile', icon: 'user', text: t('tab_profile'), noEvent: true },
      { href: basePath ~ '/admin/subscription', icon: 'credit-card', text: t('tab_subscription'), noEvent: true },
    ]
  },
  {
    header: t('menu_admin'),
    admin: true,
    items: [
      { href: basePath ~ '/admin/management', icon: 'cog', text: t('tab_management'), noEvent: true },
      { href: basePath ~ '/admin/logs', icon: 'history', text: t('tab_logs'), noEvent: true },
      { href: basePath ~ '/admin/mail-providers', icon: 'mail', text: t('tab_mail_providers'), noEvent: true },
      { href: basePath ~ '/admin/namespaces', icon: 'layers', text: t('tab_namespaces'), noEvent: true },
      { href: basePath ~ '/admin/tenants', icon: 'users', text: t('tab_tenants'), domain: 'main', noEvent: true },
    ]
  },
] %}
{% set allowMultipleAccordion = false %}
{% set accordionOptions = allowMultipleAccordion ? 'multiple: true' : 'multiple: false' %}
{% set current = currentPath %}
{% set startGroup = groups|first %}
{% set accordionGroups = groups|slice(1) %}
{% set activeNamespace = pageNamespace|default(default_namespace|default('default')) %}
{% set currentPageTab = pageTab|default('seo') %}
{% set projectNamespaces = available_namespaces|default([]) %}
{% set projectModules = [
  {
    key: 'pages',
    icon: 'file-edit',
    text: t('tab_pages'),
    path: '/admin/pages',
    tabs: ['seo', 'content'],
    admin: true
  },
  {
    key: 'wiki',
    icon: 'file-text',
    text: 'Wiki',
    path: '/admin/pages',
    pageTab: 'wiki',
    admin: true
  },
  {
    key: 'newsletter',
    icon: 'mail',
    text: t('tab_newsletter'),
    path: '/admin/management',
    anchor: 'marketingNewsletterConfigSection',
    admin: true
  },
  {
    key: 'landing-news',
    icon: 'bell',
    text: t('tab_landing_news'),
    path: '/admin/pages',
    pageTab: 'landing-news',
    admin: true
  },
  {
    key: 'media',
    icon: 'image',
    text: t('tab_media'),
    path: '/admin/media',
    roles: ['admin', 'catalog-editor']
  },
] %}

<div class="qr-sidebar-nav">
  <ul class="uk-nav uk-nav-default uk-margin-remove-bottom">
    {% for it in startGroup.items %}
      {% if (it.roles is not defined or role in it.roles)
          and (it.admin is not defined or role == 'admin')
          and (it.domain is not defined or it.domain == domainType) %}
        {% set active = current starts with it.href ? 'uk-active' : '' %}
        <li class="{{ active }}">
          <a class="qr-nav-link" href="{{ it.href }}">
            <span uk-icon="icon: {{ it.icon }}; ratio: 0.95"></span>
            <span class="qr-nav-text">{{ it.text }}</span>
          </a>
        </li>
      {% endif %}
    {% endfor %}
  </ul>

  <div class="qr-nav-accordion uk-margin-small-top" uk-accordion="{{ accordionOptions }}">
    {% set hasProjectItems = false %}
    {% for module in projectModules %}
      {% if (module.roles is not defined or role in module.roles)
          and (module.admin is not defined or role == 'admin') %}
        {% set hasProjectItems = true %}
      {% endif %}
    {% endfor %}
    {% set projectGroupActive = false %}
    {% if projectNamespaces is not empty %}
      {% set projectPagesBase = basePath ~ '/admin/pages' %}
      {% set projectManagementBase = basePath ~ '/admin/management' %}
      {% set projectMediaBase = basePath ~ '/admin/media' %}
      {% if current starts with projectPagesBase
          or current starts with projectManagementBase
          or current starts with projectMediaBase %}
        {% set projectGroupActive = true %}
      {% endif %}
    {% endif %}
    {% if hasProjectItems and projectNamespaces is not empty %}
      <div class="qr-nav-accordion-item {{ projectGroupActive ? 'uk-open' }}">
        <a class="uk-accordion-title qr-nav-accordion-title uk-text-bold" href="#">
          <span class="qr-nav-accordion-label">{{ t('menu_projects')|upper }}</span>
          <span class="uk-margin-auto-left qr-nav-accordion-chevron" uk-icon="icon: chevron-down; ratio: 0.8"></span>
        </a>
        <div class="uk-accordion-content uk-padding-remove">
          <div class="qr-nav-accordion uk-padding-small" uk-accordion="multiple: true">
            {% for namespace in projectNamespaces %}
              {% set namespaceValue = namespace|lower %}
              {% set namespaceActive = activeNamespace == namespaceValue %}
              {% set namespaceQuery = 'namespace=' ~ namespaceValue|url_encode %}
              <div class="qr-nav-accordion-item {{ namespaceActive ? 'uk-open' }}">
                <a class="uk-accordion-title qr-nav-accordion-title" href="#">
                  <span class="qr-nav-accordion-label">{{ namespace }}</span>
                  <span class="uk-margin-auto-left qr-nav-accordion-chevron" uk-icon="icon: chevron-down; ratio: 0.7"></span>
                </a>
                <div class="uk-accordion-content uk-padding-remove">
                  <ul class="uk-nav uk-nav-default qr-nav-sub">
                    {% for module in projectModules %}
                      {% if (module.roles is not defined or role in module.roles)
                          and (module.admin is not defined or role == 'admin') %}
                        {% set modulePath = basePath ~ module.path %}
                        {% if module.pageTab is defined %}
                          {% set moduleHref = modulePath ~ '?pageTab=' ~ module.pageTab ~ '&' ~ namespaceQuery %}
                        {% else %}
                          {% set moduleHref = modulePath ~ '?' ~ namespaceQuery %}
                        {% endif %}
                        {% if module.anchor is defined %}
                          {% set moduleHref = moduleHref ~ '#' ~ module.anchor %}
                        {% endif %}
                        {% set moduleActive = namespaceActive and (current starts with modulePath) %}
                        {% if module.pageTab is defined %}
                          {% set moduleActive = moduleActive and currentPageTab == module.pageTab %}
                        {% elseif module.tabs is defined %}
                          {% set moduleActive = moduleActive and currentPageTab in module.tabs %}
                        {% endif %}
                        <li class="{{ moduleActive ? 'uk-active' }}">
                          <a class="qr-nav-link qr-nav-sub-link" href="{{ moduleHref }}">
                            <span uk-icon="icon: {{ module.icon }}; ratio: 0.85"></span>
                            <span class="qr-nav-text">{{ module.text }}</span>
                          </a>
                        </li>
                      {% endif %}
                    {% endfor %}
                  </ul>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endif %}
    {% for group in accordionGroups %}
      {% if (group.admin is not defined or role == 'admin') and (group.roles is not defined or role in group.roles) %}
        {% set groupActive = false %}
        {% set hasItems = false %}
        {% for it in group.items %}
          {% if (it.roles is not defined or role in it.roles)
              and (it.admin is not defined or role == 'admin')
              and (it.domain is not defined or it.domain == domainType) %}
            {% set hasItems = true %}
            {% if current starts with it.href %}
              {% set groupActive = true %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% if hasItems %}
          <div class="qr-nav-accordion-item {{ groupActive ? 'uk-open' }}">
            <a class="uk-accordion-title qr-nav-accordion-title uk-text-bold" href="#">
              <span class="qr-nav-accordion-label">{{ group.header|upper }}</span>
              <span class="uk-margin-auto-left qr-nav-accordion-chevron" uk-icon="icon: chevron-down; ratio: 0.8"></span>
            </a>
            <div class="uk-accordion-content uk-padding-remove">
              <ul class="uk-nav uk-nav-default qr-nav-sub">
                {% for it in group.items %}
                  {% if (it.roles is not defined or role in it.roles)
                      and (it.admin is not defined or role == 'admin')
                      and (it.domain is not defined or it.domain == domainType) %}
                    {% set active = current starts with it.href ? 'uk-active' : '' %}
                    <li class="{{ active }}">
                      <a class="qr-nav-link qr-nav-sub-link" href="{{ it.href }}">
                        <span uk-icon="icon: {{ it.icon }}; ratio: 0.85"></span>
                        <span class="qr-nav-text">{{ it.text }}</span>
                      </a>
                    </li>
                  {% endif %}
                {% endfor %}
              </ul>
            </div>
          </div>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>

  <ul class="uk-nav uk-nav-default uk-margin-top">
    <li class="uk-nav-divider"></li>
    <li>
      <a class="qr-nav-link" href="{{ basePath }}/logout">
        <span uk-icon="icon: sign-out; ratio: 0.95"></span>
        <span class="qr-nav-text">{{ t('logout') }}</span>
      </a>
    </li>
  </ul>
</div>
