{% set groups = [
  {
    items: [
      {
        href: basePath ~ '/admin/dashboard',
        icon: 'home',
        text: t('tab_dashboard'),
        noEvent: true
      },
    ]
  },
  {
    header: t('menu_event_management'),
    items: [
      { href: basePath ~ '/admin/events', icon: 'calendar', text: t('tab_events') },
      { href: basePath ~ '/admin/event/dashboard', icon: 'tv', text: t('tab_event_dashboard') },
      { href: basePath ~ '/admin/event/settings', icon: 'cog', text: t('tab_event_settings') },
      { href: basePath ~ '/admin/username-blocklist', icon: 'lock', text: t('tab_username_settings'), admin: true },
      { href: basePath ~ '/admin/summary', icon: 'table', text: t('tab_summary') },
      { href: basePath ~ '/admin/catalogs', icon: 'database', text: t('tab_catalogs'), roles: ['admin', 'catalog-editor'] },
      { href: basePath ~ '/admin/questions', icon: 'question', text: t('tab_questions') },
      { href: basePath ~ '/admin/teams', icon: 'users', text: t('tab_teams') },
      { href: basePath ~ '/admin/results', icon: 'list', text: t('tab_results') },
      { href: basePath ~ '/admin/statistics', icon: 'signal', text: t('tab_statistics') },
    ]
  },
  {
    header: t('menu_projects'),
    admin: true,
    type: 'projects'
  },
  {
    header: t('menu_account'),
    items: [
      { href: basePath ~ '/admin/profile', icon: 'user', text: t('tab_profile'), noEvent: true },
      { href: basePath ~ '/admin/subscription', icon: 'credit-card', text: t('tab_subscription'), noEvent: true },
    ]
  },
  {
    header: t('menu_admin'),
    admin: true,
    items: [
      {
        href: basePath ~ '/admin/logins',
        icon: 'sign-in',
        text: t('menu_admin_logins'),
        noEvent: true,
        noNamespace: true
      },
      {
        href: basePath ~ '/admin/management#domains',
        icon: 'world',
        text: t('menu_admin_domains'),
        noEvent: true
      },
      {
        href: basePath ~ '/admin/management#backups',
        icon: 'database',
        text: t('heading_backups'),
        noEvent: true
      },
    ]
  },
] %}
{% set allowMultipleAccordion = false %}
{% set accordionOptions = allowMultipleAccordion ? 'multiple: true' : 'multiple: false' %}
{% set current = currentPath %}
{% set activeNamespace = pageNamespace|default('default') %}
{% set namespaceQuery = activeNamespace is not empty ? 'namespace=' ~ activeNamespace|url_encode : '' %}
{% set lockNamespaceSelect = current starts with (basePath ~ '/admin/logins') %}
{# Web management modules grouped by responsibility for clearer navigation and future extension #}
{% set projectModules = [
  {
    header: t('menu_web_dashboard'),
    items: [
      { href: basePath ~ '/admin/projects', icon: 'grid', text: t('tab_project_overview'), activePrefixes: [basePath ~ '/admin/projects'] },
    ]
  },
  {
    header: t('menu_web_content'),
    items: [
      {
        href: basePath ~ '/admin/pages/content',
        icon: 'file-edit',
        text: t('tab_pages'),
        activePaths: [basePath ~ '/admin/pages'],
        activePrefixes: [basePath ~ '/admin/pages/content']
      },
      { href: basePath ~ '/admin/pages/wiki', icon: 'file-text', text: t('tab_wiki'), activePrefixes: [basePath ~ '/admin/pages/wiki'] },
      { href: basePath ~ '/admin/landing-news', icon: 'commenting', text: t('tab_landing_news'), activePrefixes: [basePath ~ '/admin/landing-news'] },
      { href: basePath ~ '/admin/newsletter', icon: 'mail', text: t('tab_newsletter'), activePrefixes: [basePath ~ '/admin/newsletter'] },
    ]
  },
  {
    header: t('menu_web_media_assets'),
    items: [
      {
        href: basePath ~ '/admin/media',
        icon: 'image',
        text: t('tab_media'),
        activePrefixes: [basePath ~ '/admin/media'],
        roles: ['admin', 'catalog-editor'],
        noEvent: true
      },
    ]
  },
  {
    header: t('menu_web_structure'),
    items: [
      { href: basePath ~ '/admin/pages/navigation', icon: 'list', text: t('tab_navigation'), activePrefixes: [basePath ~ '/admin/pages/navigation'] },
    ]
  },
  {
    header: t('menu_web_marketing'),
    items: [
      { href: basePath ~ '/admin/pages/seo', icon: 'search', text: t('tab_page_seo_base'), activePrefixes: [basePath ~ '/admin/pages/seo'] },
      { href: basePath ~ '/admin/pages/cookies', icon: 'file-text', text: t('tab_cookies'), activePrefixes: [basePath ~ '/admin/pages/cookies'] },
    ]
  },
  {
    header: t('menu_web_interaction'),
    items: [
      { href: basePath ~ '/admin/rag-chat', icon: 'comments', text: t('tab_rag_chat'), activePrefixes: [basePath ~ '/admin/rag-chat'] },
    ]
  },
  {
    header: t('menu_web_design'),
    items: [
      { href: basePath ~ '/admin/pages/content#design', icon: 'paint-bucket', text: t('tab_design'), activePrefixes: [basePath ~ '/admin/pages/content'] },
    ]
  },
] %}
{% set projectNamespaceOptions = available_namespaces|default([]) %}
{% if projectNamespaceOptions is empty %}
  {% set projectNamespaceOptions = [{
    namespace: activeNamespace,
    label: null,
    is_active: true
  }] %}
{% endif %}
{% set activeNamespaceExists = false %}
{% for entry in projectNamespaceOptions %}
  {% if entry.namespace|default('') == activeNamespace %}
    {% set activeNamespaceExists = true %}
  {% endif %}
{% endfor %}
{% if not activeNamespaceExists %}
  {% set projectNamespaceOptions = projectNamespaceOptions|merge([{
    namespace: activeNamespace,
    label: null,
    is_active: false
  }]) %}
{% endif %}
{% set startGroup = groups|first %}
{% set accordionGroups = groups|slice(1) %}

<div class="qr-sidebar-nav">
  <div class="uk-margin-small">
    <label class="uk-form-label" for="namespaceSelect">{{ t('label_project_namespace') }}</label>
    <div class="uk-form-controls">
      <select
        id="namespaceSelect"
        class="uk-select"
        data-namespace="{{ activeNamespace|e('html_attr') }}"
        {% if lockNamespaceSelect %}disabled{% endif %}
      >
        {% for entry in projectNamespaceOptions %}
          {% set entryNamespace = entry.namespace|default('') %}
          {% set entryLabel = entry.label|default('') %}
          {% set entryIsInactive = entry.is_active is defined and not entry.is_active %}
          <option
            value="{{ entryNamespace|e('html_attr') }}"
            {% if entryNamespace == activeNamespace %}selected{% endif %}
          >
            {{ entryNamespace }}
            {% if entryLabel is not empty %}· {{ entryLabel }}{% endif %}
            {% if entryIsInactive %}· inaktiv{% endif %}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="uk-text-meta uk-margin-small-top">{{ t('text_project_namespace_hint') }}</div>
  </div>
  <ul class="uk-nav uk-nav-default uk-margin-remove-bottom">
    {% for it in startGroup.items %}
      {% if (it.roles is not defined or role in it.roles)
          and (it.admin is not defined or role == 'admin')
          and (it.domain is not defined or it.domain == domainType) %}
        {% set active = current starts with it.href ? 'uk-active' : '' %}
        {% set hrefParts = it.href|split('#', 2) %}
        {% set hrefBase = hrefParts[0] %}
        {% set hrefAnchor = hrefParts|length > 1 ? '#' ~ hrefParts[1] : '' %}
        {% set namespaceSuffix = '' %}
        {% if namespaceQuery is not empty and (it.noNamespace is not defined or not it.noNamespace) %}
          {% set namespaceSuffix = ('?' in hrefBase) ? '&' ~ namespaceQuery : '?' ~ namespaceQuery %}
        {% endif %}
        {% set href = hrefBase ~ namespaceSuffix ~ hrefAnchor %}
        <li class="{{ active }}">
          <a class="qr-nav-link" href="{{ href }}">
            <span uk-icon="icon: {{ it.icon }}; ratio: 0.95"></span>
            <span class="qr-nav-text">{{ it.text }}</span>
          </a>
        </li>
      {% endif %}
    {% endfor %}
  </ul>

  <div class="qr-nav-accordion uk-margin-small-top" uk-accordion="{{ accordionOptions }}">
    {% for group in accordionGroups %}
      {% if (group.admin is not defined or role == 'admin') and (group.roles is not defined or role in group.roles) %}
        {% if group.type is defined and group.type == 'projects' %}
          {% set groupActive = false %}
          {% for section in projectModules %}
            {% for module in section.items %}
              {% set activePaths = module.activePaths|default([]) %}
              {% set activePrefixes = module.activePrefixes|default([]) %}
              {% set moduleActive = false %}
              {% for path in activePaths %}
                {% if current == path %}
                  {% set moduleActive = true %}
                {% endif %}
              {% endfor %}
              {% for prefix in activePrefixes %}
                {% if current starts with prefix %}
                  {% set moduleActive = true %}
                {% endif %}
              {% endfor %}
              {% if moduleActive %}
                {% set groupActive = true %}
              {% endif %}
            {% endfor %}
          {% endfor %}
          <div class="qr-nav-accordion-item {{ groupActive ? 'uk-open' }}">
            <a class="uk-accordion-title qr-nav-accordion-title uk-text-bold" href="#">
              <span class="qr-nav-accordion-label">{{ group.header|upper }}</span>
              <span class="uk-margin-auto-left qr-nav-accordion-chevron" uk-icon="icon: chevron-down; ratio: 0.8"></span>
            </a>
            <div class="uk-accordion-content uk-padding-remove">
              <ul class="uk-nav uk-nav-default qr-nav-sub">
                {% for section in projectModules %}
                  {% set hasVisibleModule = false %}
                  {% for module in section.items %}
                    {% if module.roles is not defined or role in module.roles %}
                      {% set hasVisibleModule = true %}
                    {% endif %}
                  {% endfor %}
                  {% if hasVisibleModule %}
                    <li class="uk-nav-header">{{ section.header }}</li>
                    {% for module in section.items %}
                      {% if module.roles is not defined or role in module.roles %}
                        {% set activePaths = module.activePaths|default([]) %}
                        {% set activePrefixes = module.activePrefixes|default([]) %}
                        {% set isActive = false %}
                        {% for path in activePaths %}
                          {% if current == path %}
                            {% set isActive = true %}
                          {% endif %}
                        {% endfor %}
                        {% for prefix in activePrefixes %}
                          {% if current starts with prefix %}
                            {% set isActive = true %}
                          {% endif %}
                        {% endfor %}
                        {% set moduleQuery = module.query|default('') %}
                        {% set moduleQueryPrefix = moduleQuery is not empty ? '?' ~ moduleQuery : '' %}
                        {% set namespaceSuffix = namespaceQuery is not empty ? (moduleQuery is not empty ? '&' : '?') ~ namespaceQuery : '' %}
                        <li class="{{ isActive ? 'uk-active' : '' }}">
                          <a
                            class="qr-nav-link qr-nav-sub-link"
                            href="{{ module.href }}{{ moduleQueryPrefix }}{{ namespaceSuffix }}{{ module.anchor|default('') }}"
                          >
                            <span uk-icon="icon: {{ module.icon }}; ratio: 0.85"></span>
                            <span class="qr-nav-text">{{ module.text }}</span>
                          </a>
                        </li>
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                {% endfor %}
              </ul>
            </div>
          </div>
        {% else %}
          {% set groupActive = false %}
          {% set hasItems = false %}
          {% for it in group.items %}
            {% if (it.roles is not defined or role in it.roles)
                and (it.admin is not defined or role == 'admin')
                and (it.domain is not defined or it.domain == domainType) %}
              {% set hasItems = true %}
              {% if current starts with it.href %}
                {% set groupActive = true %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if hasItems %}
            <div class="qr-nav-accordion-item {{ groupActive ? 'uk-open' }}">
              <a class="uk-accordion-title qr-nav-accordion-title uk-text-bold" href="#">
                <span class="qr-nav-accordion-label">{{ group.header|upper }}</span>
                <span class="uk-margin-auto-left qr-nav-accordion-chevron" uk-icon="icon: chevron-down; ratio: 0.8"></span>
              </a>
              <div class="uk-accordion-content uk-padding-remove">
                <ul class="uk-nav uk-nav-default qr-nav-sub">
                  {% for it in group.items %}
                    {% if (it.roles is not defined or role in it.roles)
                        and (it.admin is not defined or role == 'admin')
                        and (it.domain is not defined or it.domain == domainType) %}
                      {% set active = current starts with it.href ? 'uk-active' : '' %}
                      {% set hrefParts = it.href|split('#', 2) %}
                      {% set hrefBase = hrefParts[0] %}
                      {% set hrefAnchor = hrefParts|length > 1 ? '#' ~ hrefParts[1] : '' %}
                      {% set namespaceSuffix = '' %}
                      {% if namespaceQuery is not empty %}
                        {% set namespaceSuffix = ('?' in hrefBase) ? '&' ~ namespaceQuery : '?' ~ namespaceQuery %}
                      {% endif %}
                      {% set href = hrefBase ~ namespaceSuffix ~ hrefAnchor %}
                      <li class="{{ active }}">
                        <a class="qr-nav-link qr-nav-sub-link" href="{{ href }}">
                          <span uk-icon="icon: {{ it.icon }}; ratio: 0.85"></span>
                          <span class="qr-nav-text">{{ it.text }}</span>
                        </a>
                      </li>
                    {% endif %}
                  {% endfor %}
                </ul>
              </div>
            </div>
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>

  <ul class="uk-nav uk-nav-default uk-margin-top">
    <li class="uk-nav-divider"></li>
    <li>
      <a class="qr-nav-link" href="{{ basePath }}/logout">
        <span uk-icon="icon: sign-out; ratio: 0.95"></span>
        <span class="qr-nav-text">{{ t('logout') }}</span>
      </a>
    </li>
  </ul>
</div>
