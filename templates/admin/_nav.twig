{% set groups = [
  {
    items: [
      {
        href: basePath ~ '/admin/dashboard',
        icon: 'home',
        text: t('tab_dashboard'),
        noEvent: true
      },
    ]
  },
  {
    header: t('menu_event_management'),
    items: [
      { href: basePath ~ '/admin/events', icon: 'calendar', text: t('tab_events') },
      { href: basePath ~ '/admin/event/dashboard', icon: 'tv', text: t('tab_event_dashboard') },
      { href: basePath ~ '/admin/event/settings', icon: 'cog', text: t('tab_event_settings') },
      { href: basePath ~ '/admin/username-blocklist', icon: 'lock', text: t('tab_username_settings'), admin: true },
      { href: basePath ~ '/admin/summary', icon: 'table', text: t('tab_summary') },
      { href: basePath ~ '/admin/catalogs', icon: 'database', text: t('tab_catalogs'), roles: ['admin', 'catalog-editor'] },
      { href: basePath ~ '/admin/questions', icon: 'question', text: t('tab_questions') },
      { href: basePath ~ '/admin/teams', icon: 'users', text: t('tab_teams') },
      { href: basePath ~ '/admin/results', icon: 'list', text: t('tab_results') },
      { href: basePath ~ '/admin/statistics', icon: 'signal', text: t('tab_statistics') },
    ]
  },
  {
    header: t('menu_content'),
    items: [
      {
        href: basePath ~ '/admin/media',
        icon: 'image',
        text: t('tab_media'),
        roles: ['admin', 'catalog-editor'],
        noEvent: true
      },
    ]
  },
  {
    header: t('menu_projects'),
    admin: true,
    type: 'projects'
  },
  {
    header: t('menu_account'),
    items: [
      { href: basePath ~ '/admin/profile', icon: 'user', text: t('tab_profile'), noEvent: true },
      { href: basePath ~ '/admin/subscription', icon: 'credit-card', text: t('tab_subscription'), noEvent: true },
    ]
  },
  {
    header: t('menu_admin'),
    admin: true,
    items: [
      { href: basePath ~ '/admin/domains', icon: 'world', text: t('menu_admin_domains'), noEvent: true },
      { href: basePath ~ '/admin/logins', icon: 'sign-in', text: t('menu_admin_logins'), noEvent: true },
      { href: basePath ~ '/admin/backups', icon: 'database', text: t('menu_admin_backups'), noEvent: true },
    ]
  },
] %}
{% set allowMultipleAccordion = false %}
{% set accordionOptions = allowMultipleAccordion ? 'multiple: true' : 'multiple: false' %}
{% set current = currentPath %}
{% set activeNamespace = pageNamespace|default('default') %}
{% set projectModules = [
  { href: basePath ~ '/admin/projects', icon: 'grid', text: t('tab_project_overview') },
  { href: basePath ~ '/admin/pages/content', icon: 'file-edit', text: t('tab_pages'), pageTab: 'content', matchPrefix: basePath ~ '/admin/pages' },
  { href: basePath ~ '/admin/pages/navigation', icon: 'list', text: t('tab_navigation'), pageTab: 'navigation' },
  { href: basePath ~ '/admin/pages/seo', icon: 'search', text: t('tab_page_seo_base'), pageTab: 'seo' },
  { href: basePath ~ '/admin/pages/wiki', icon: 'file-text', text: t('tab_wiki'), pageTab: 'wiki' },
  { href: basePath ~ '/admin/pages/cookies', icon: 'file-text', text: t('tab_cookies'), pageTab: 'cookies' },
  { href: basePath ~ '/admin/landing-news', icon: 'commenting', text: t('tab_landing_news'), pageTab: 'landing-news' },
  { href: basePath ~ '/admin/rag-chat', icon: 'comments', text: t('tab_rag_chat') },
  { href: basePath ~ '/admin/newsletter', icon: 'mail', text: t('tab_newsletter'), pageTab: 'newsletter' },
] %}
{% set projectNamespaceOptions = available_namespaces|default([]) %}
{% if projectNamespaceOptions is empty %}
  {% set projectNamespaceOptions = [{
    namespace: activeNamespace,
    label: null,
    is_active: true
  }] %}
{% endif %}
{% set activeNamespaceExists = false %}
{% for entry in projectNamespaceOptions %}
  {% if entry.namespace|default('') == activeNamespace %}
    {% set activeNamespaceExists = true %}
  {% endif %}
{% endfor %}
{% if not activeNamespaceExists %}
  {% set projectNamespaceOptions = projectNamespaceOptions|merge([{
    namespace: activeNamespace,
    label: null,
    is_active: false
  }]) %}
{% endif %}
{% set startGroup = groups|first %}
{% set accordionGroups = groups|slice(1) %}

<div class="qr-sidebar-nav">
  <ul class="uk-nav uk-nav-default uk-margin-remove-bottom">
    {% for it in startGroup.items %}
      {% if (it.roles is not defined or role in it.roles)
          and (it.admin is not defined or role == 'admin')
          and (it.domain is not defined or it.domain == domainType) %}
        {% set active = current starts with it.href ? 'uk-active' : '' %}
        <li class="{{ active }}">
          <a class="qr-nav-link" href="{{ it.href }}">
            <span uk-icon="icon: {{ it.icon }}; ratio: 0.95"></span>
            <span class="qr-nav-text">{{ it.text }}</span>
          </a>
        </li>
      {% endif %}
    {% endfor %}
  </ul>

  <div class="qr-nav-accordion uk-margin-small-top" uk-accordion="{{ accordionOptions }}">
    {% for group in accordionGroups %}
      {% if (group.admin is not defined or role == 'admin') and (group.roles is not defined or role in group.roles) %}
        {% if group.type is defined and group.type == 'projects' %}
          {% set groupActive = false %}
          {% set hasItems = false %}
          {% for entry in projectNamespaceOptions %}
            {% set hasItems = true %}
            {% set namespaceValue = entry.namespace|default('') %}
            {% if namespaceValue == activeNamespace %}
              {% for module in projectModules %}
                {% set matchPrefix = module.matchPrefix|default('') %}
                {% if current starts with module.href or (matchPrefix is not empty and current starts with matchPrefix) %}
                  {% set groupActive = true %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
          {% if hasItems %}
            <div class="qr-nav-accordion-item {{ groupActive ? 'uk-open' }}">
              <a class="uk-accordion-title qr-nav-accordion-title uk-text-bold" href="#">
                <span class="qr-nav-accordion-label">{{ group.header|upper }}</span>
                <span class="uk-margin-auto-left qr-nav-accordion-chevron" uk-icon="icon: chevron-down; ratio: 0.8"></span>
              </a>
              <div class="uk-accordion-content uk-padding-remove">
                <div class="qr-nav-accordion" uk-accordion="{{ accordionOptions }}">
                  {% for entry in projectNamespaceOptions %}
                    {% set namespaceValue = entry.namespace|default('') %}
                    {% set namespaceLabel = entry.label|default('') %}
{% set modulePageTab = pageTab|default('') %}
{% set modulePageSlug = selectedPageSlug|default('') %}
{% set projectSlugModules = [] %}
{% for module in projectModules %}
  {% if module.pageSlug is defined %}
    {% set projectSlugModules = projectSlugModules|merge([module.pageSlug]) %}
  {% endif %}
{% endfor %}
{% set hasSpecificSlugMatch = modulePageSlug is not empty and modulePageSlug in projectSlugModules %}
                      {% set namespaceActive = namespaceValue == activeNamespace %}
                      {% set namespaceHasActive = false %}
                      {% for module in projectModules %}
                        {% set matchPrefix = module.matchPrefix|default('') %}
                        {% set pathMatches = current starts with module.href or (matchPrefix is not empty and current starts with matchPrefix) %}
                        {% set tabMatches = module.pageTab is not defined or module.pageTab == modulePageTab %}
                        {% if module.pageSlug is defined %}
                          {% set slugMatches = module.pageSlug == modulePageSlug %}
                        {% else %}
                          {% set slugMatches = not hasSpecificSlugMatch %}
                        {% endif %}
                        {% if namespaceActive and pathMatches and tabMatches and slugMatches %}
                          {% set namespaceHasActive = true %}
                        {% endif %}
                      {% endfor %}
                      <div class="qr-nav-accordion-item {{ namespaceHasActive ? 'uk-open' }}">
                        <a class="uk-accordion-title qr-nav-accordion-title uk-text-bold" href="#">
                          <span class="qr-nav-accordion-label">
                            {{ namespaceValue }}
                            {% if namespaceLabel is not empty %}· {{ namespaceLabel }}{% endif %}
                            {% if entry.is_active is defined and not entry.is_active %}· inaktiv{% endif %}
                          </span>
                          <span class="uk-margin-auto-left qr-nav-accordion-chevron" uk-icon="icon: chevron-down; ratio: 0.8"></span>
                        </a>
                        <div class="uk-accordion-content uk-padding-remove">
                          <ul class="uk-nav uk-nav-default qr-nav-sub">
                            {% for module in projectModules %}
                              {% set matchPrefix = module.matchPrefix|default('') %}
                              {% set pathMatches = current starts with module.href or (matchPrefix is not empty and current starts with matchPrefix) %}
                              {% set tabMatches = module.pageTab is not defined or module.pageTab == modulePageTab %}
                              {% if module.pageSlug is defined %}
                                {% set slugMatches = module.pageSlug == modulePageSlug %}
                              {% else %}
                                {% set slugMatches = not hasSpecificSlugMatch %}
                              {% endif %}
                              {% set isActive = namespaceActive and pathMatches and tabMatches and slugMatches %}
                              {% set moduleQuery = module.query|default('') %}
                              {% set moduleQueryPrefix = moduleQuery is not empty ? '?' ~ moduleQuery : '' %}
                              {% set namespaceQuery = namespaceValue is not empty ? (moduleQuery is not empty ? '&' : '?') ~ 'namespace=' ~ namespaceValue|url_encode : '' %}
                              <li class="{{ isActive ? 'uk-active' : '' }}">
                                <a
                                  class="qr-nav-link qr-nav-sub-link"
                                  href="{{ module.href }}{{ moduleQueryPrefix }}{{ namespaceQuery }}{{ module.anchor|default('') }}"
                                >
                                  <span uk-icon="icon: {{ module.icon }}; ratio: 0.85"></span>
                                  <span class="qr-nav-text">{{ module.text }}</span>
                                </a>
                              </li>
                            {% endfor %}
                          </ul>
                        </div>
                      </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          {% endif %}
        {% else %}
          {% set groupActive = false %}
          {% set hasItems = false %}
          {% for it in group.items %}
            {% if (it.roles is not defined or role in it.roles)
                and (it.admin is not defined or role == 'admin')
                and (it.domain is not defined or it.domain == domainType) %}
              {% set hasItems = true %}
              {% if current starts with it.href %}
                {% set groupActive = true %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if hasItems %}
            <div class="qr-nav-accordion-item {{ groupActive ? 'uk-open' }}">
              <a class="uk-accordion-title qr-nav-accordion-title uk-text-bold" href="#">
                <span class="qr-nav-accordion-label">{{ group.header|upper }}</span>
                <span class="uk-margin-auto-left qr-nav-accordion-chevron" uk-icon="icon: chevron-down; ratio: 0.8"></span>
              </a>
              <div class="uk-accordion-content uk-padding-remove">
                <ul class="uk-nav uk-nav-default qr-nav-sub">
                  {% for it in group.items %}
                    {% if (it.roles is not defined or role in it.roles)
                        and (it.admin is not defined or role == 'admin')
                        and (it.domain is not defined or it.domain == domainType) %}
                      {% set active = current starts with it.href ? 'uk-active' : '' %}
                      <li class="{{ active }}">
                        <a class="qr-nav-link qr-nav-sub-link" href="{{ it.href }}">
                          <span uk-icon="icon: {{ it.icon }}; ratio: 0.85"></span>
                          <span class="qr-nav-text">{{ it.text }}</span>
                        </a>
                      </li>
                    {% endif %}
                  {% endfor %}
                </ul>
              </div>
            </div>
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>

  <ul class="uk-nav uk-nav-default uk-margin-top">
    <li class="uk-nav-divider"></li>
    <li>
      <a class="qr-nav-link" href="{{ basePath }}/logout">
        <span uk-icon="icon: sign-out; ratio: 0.95"></span>
        <span class="qr-nav-text">{{ t('logout') }}</span>
      </a>
    </li>
  </ul>
</div>
