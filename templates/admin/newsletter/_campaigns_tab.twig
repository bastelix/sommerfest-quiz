{# Campaign listing and editor #}
{% import 'components/standard_table.twig' as tables %}
{% set editCampaign = activeCampaign is defined and activeCampaign ? activeCampaign : null %}
{% set activePageNamespace = pageNamespace|default('default') %}
{% set pageNamespaceQuery = activePageNamespace is not empty ? '?namespace=' ~ activePageNamespace|url_encode : '' %}

{% if error_message is defined and error_message %}
  <div class="uk-alert-danger" uk-alert>
    <a class="uk-alert-close" uk-close></a>
    <p>{{ error_message }}</p>
  </div>
{% endif %}

<div class="uk-card uk-card-default uk-card-body uk-margin">
  <h2 class="uk-card-title">{{ t('heading_newsletter_campaign_list') }}</h2>
  {% set headings = [
    { label: t('label_campaign_name') },
    { label: t('label_campaign_news'), class: 'uk-table-expand' },
    { label: t('label_campaign_status') },
    { label: t('label_campaign_sent_at') },
    { label: t('actions'), class: 'uk-table-shrink uk-text-right' },
  ] %}
  {% set campaignRows %}
    {% for campaign in campaigns %}
      {% set editBase = basePath ~ '/admin/newsletter' ~ pageNamespaceQuery %}
      {% set editLink = editBase ~ (pageNamespaceQuery ? '&' : '?') ~ 'edit=' ~ campaign.id %}
      <tr>
        <td data-title="{{ t('label_campaign_name') }}">{{ campaign.name }}</td>
        <td data-title="{{ t('label_campaign_news') }}">
          {% if campaign.newsIds %}
            <ul class="uk-list uk-list-collapse">
              {% for newsId in campaign.newsIds %}
                {% set newsEntry = (newsEntries|filter(n => n.id == newsId)|first) %}
                <li>{{ newsEntry ? newsEntry.title : '#' ~ newsId }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <span class="uk-text-muted">{{ t('text_campaign_no_news') }}</span>
          {% endif %}
        </td>
        <td data-title="{{ t('label_campaign_status') }}">
          {% if campaign.status == 'sent' %}
            <span class="uk-label uk-label-success">{{ t('label_status_sent') }}</span>
          {% elseif campaign.status == 'failed' %}
            <span class="uk-label uk-label-danger">{{ t('label_status_failed') }}</span>
          {% elseif campaign.status == 'ready' %}
            <span class="uk-label uk-label-warning">{{ t('label_status_ready') }}</span>
          {% else %}
            <span class="uk-label">{{ t('label_status_draft') }}</span>
          {% endif %}
        </td>
        <td data-title="{{ t('label_campaign_sent_at') }}">
          {% if campaign.sentAt %}
            {{ campaign.sentAt|date('d.m.Y H:i') }}
          {% else %}
            <span class="uk-text-muted">{{ t('text_campaign_not_sent') }}</span>
          {% endif %}
        </td>
        <td class="uk-table-shrink uk-text-right" data-title="{{ t('actions') }}">
          <div class="uk-inline">
            <button
              class="uk-button uk-button-default uk-button-small"
              type="button"
              uk-icon="icon: more; ratio: 0.9"
              aria-label="{{ t('actions') }}"
            >
              <span class="uk-hidden">{{ t('actions') }}</span>
            </button>
            <div uk-dropdown="mode: click; pos: bottom-right; offset: 0; container: .admin-page">
              <ul class="uk-nav uk-dropdown-nav">
                <li>
                  <a class="uk-button uk-button-link uk-width-1-1 uk-text-left" href="{{ editLink }}">{{ t('button_edit') }}</a>
                </li>
                {% if campaign.status != 'sent' %}
                <li>
                  <form method="post" action="{{ basePath }}/admin/newsletter-campaigns/{{ campaign.id }}/send{{ pageNamespaceQuery }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <button class="uk-button uk-button-link uk-width-1-1 uk-text-left" type="submit"
                      onclick="return confirm('{{ t('confirm_send_campaign') }}')">{{ t('button_send_campaign') }}</button>
                  </form>
                </li>
                {% endif %}
              </ul>
            </div>
          </div>
        </td>
      </tr>
    {% else %}
      <tr>
        <td colspan="5" class="uk-text-center uk-text-muted">{{ t('text_campaigns_empty') }}</td>
      </tr>
    {% endfor %}
  {% endset %}
  {{ tables.render(headings, 'newsletterCampaignTableBody', campaignRows) }}
</div>

<div class="uk-card uk-card-default uk-card-body uk-margin">
  <h2 class="uk-card-title">{{ editCampaign ? t('heading_edit_campaign') : t('heading_create_campaign') }}</h2>
  <form method="post" action="{{ basePath }}/admin/newsletter-campaigns{{ pageNamespaceQuery }}" class="uk-form-stacked">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    {% if editCampaign %}
      <input type="hidden" name="id" value="{{ editCampaign.id }}">
    {% endif %}
    <div class="uk-margin">
      <label class="uk-form-label" for="campaignName">{{ t('label_campaign_name') }}</label>
      <div class="uk-form-controls">
        <input class="uk-input" id="campaignName" name="name" type="text" value="{{ editCampaign ? editCampaign.name : '' }}" required>
      </div>
    </div>
    <div class="uk-margin">
      <label class="uk-form-label" for="campaignNews">{{ t('label_campaign_news') }}</label>
      <div class="uk-form-controls">
        <select class="uk-select" id="campaignNews" name="news_ids[]" multiple size="6">
          {% for entry in newsEntries %}
            {% set selected = editCampaign and entry.id in editCampaign.newsIds %}
            <option value="{{ entry.id }}" {% if selected %}selected{% endif %}>
              {{ entry.title }} ({{ entry.pageSlug }})
            </option>
          {% endfor %}
        </select>
        <p class="uk-text-meta uk-margin-small-top">{{ t('text_campaign_news_hint') }}</p>
      </div>
    </div>

    <input type="hidden" name="status" value="{{ editCampaign ? editCampaign.status : 'draft' }}">

    <details class="uk-margin">
      <summary class="uk-text-meta" style="cursor: pointer;">
        {{ t('label_advanced_campaign_settings') }}
      </summary>
      <div class="uk-margin-small-top uk-padding-small" style="background: #f8f9fa; border-radius: 4px;">
        <div class="uk-margin-small">
          <label class="uk-form-label" for="campaignTemplate">{{ t('label_campaign_template') }}</label>
          <div class="uk-form-controls">
            <input class="uk-input" id="campaignTemplate" name="template_id" type="text"
              value="{{ editCampaign ? editCampaign.templateId : defaultTemplateId|default('') }}">
          </div>
          <p class="uk-text-meta uk-margin-small-top">{{ t('text_campaign_template_hint') }}</p>
        </div>
        <div class="uk-margin-small">
          <label class="uk-form-label" for="campaignAudience">{{ t('label_campaign_audience') }}</label>
          <div class="uk-form-controls">
            <input class="uk-input" id="campaignAudience" name="audience_id" type="text"
              value="{{ editCampaign ? editCampaign.audienceId : defaultAudienceId|default('') }}">
          </div>
          <p class="uk-text-meta uk-margin-small-top">{{ t('text_campaign_audience_hint') }}</p>
        </div>
        <div class="uk-margin-small">
          <label class="uk-form-label" for="campaignSchedule">{{ t('label_campaign_scheduled_for') }}</label>
          <div class="uk-form-controls">
            <input class="uk-input" id="campaignSchedule" name="scheduled_for" type="datetime-local" value="{{ editCampaign and editCampaign.scheduledFor ? editCampaign.scheduledFor|date('Y-m-d\\TH:i') : '' }}">
          </div>
        </div>
      </div>
    </details>

    <div class="uk-margin">
      <button class="uk-button uk-button-primary" type="submit">
        {{ editCampaign ? t('button_save_campaign') : t('button_create_campaign') }}
      </button>
    </div>
  </form>
</div>
