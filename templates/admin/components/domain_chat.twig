{% set domainChatDomains = domain_chat_domains|default([]) %}
{% set domainChatPages = domain_chat_pages|default([]) %}
{% set domainChatMaxSize = (constant('App\\Service\\RagChat\\DomainDocumentStorage::MAX_FILE_SIZE') / 1048576)|number_format(1, '.', '') %}
<h3 class="uk-heading-bullet uk-margin-large-top">{{ t('heading_domain_chat') }}</h3>
{% if domainChatDomains is empty and domainChatPages is empty %}
  <p class="uk-text-meta">{{ t('text_domain_chat_no_domains') }}</p>
{% else %}
  <div
    class="uk-card uk-card-default uk-card-small uk-margin"
    data-domain-chat
    data-empty="{{ t('text_domain_chat_empty') }}"
    data-loading="{{ t('text_domain_chat_loading') }}"
    data-error="{{ t('notify_domain_chat_error') }}"
    data-confirm="{{ t('confirm_domain_chat_delete') }}"
  >
    <div class="uk-card-body">
      <form class="uk-grid-small uk-flex-middle" uk-grid data-domain-chat-form>
        <div class="uk-width-1-1 uk-width-1-3@m">
          <label class="uk-form-label" for="domainChatSelect">{{ t('label_domain_chat_domain') }}</label>
          <div class="uk-form-controls">
            <select id="domainChatSelect" class="uk-select" data-domain-chat-select>
              {% if domainChatDomains is not empty %}
                <optgroup label="{{ t('optgroup_domain_chat_domains') }}">
                  {% for item in domainChatDomains %}
                    {% set optionValue = item.normalized_host|default(item.host|default('')) %}
                    {% if optionValue is not empty %}
                      {% set baseLabel = item.label|default(item.host|default(optionValue)) %}
                      {% set fullLabel = baseLabel %}
                      {% set namespaceLabel = item.namespace|default('') %}
                      {% if namespaceLabel is not empty %}
                        {% set fullLabel = fullLabel ~ ' · ' ~ namespaceLabel %}
                      {% endif %}
                      <option value="{{ optionValue }}" data-type="domain">{{ fullLabel }}</option>
                    {% endif %}
                  {% endfor %}
                </optgroup>
              {% endif %}
              {% if domainChatPages is not empty %}
                <optgroup label="{{ t('optgroup_domain_chat_pages') }}">
                  {% for page in domainChatPages %}
                    {% set pageSlug = page.slug|default('') %}
                    {% if pageSlug is not empty %}
                      {% set baseLabel = page.title|default(pageSlug) %}
                      {% set typeLabel = t('label_domain_chat_marketing_page') %}
                      {% set fullLabel = baseLabel %}
                      {% if typeLabel is not empty %}
                        {% set fullLabel = fullLabel ~ ' – ' ~ typeLabel %}
                      {% endif %}
                      {% if pageSlug|lower != baseLabel|lower %}
                        {% set fullLabel = fullLabel ~ ' (' ~ pageSlug ~ ')' %}
                      {% endif %}
                      <option value="{{ pageSlug }}" data-type="marketing-page">{{ fullLabel }}</option>
                    {% endif %}
                  {% endfor %}
                </optgroup>
              {% endif %}
            </select>
          </div>
        </div>
        <div class="uk-width-1-1 uk-width-expand@m">
          <label class="uk-form-label" for="domainChatFile">{{ t('label_domain_chat_upload') }}</label>
          <div class="uk-form-controls">
            <div class="uk-grid-small" uk-grid>
              <div class="uk-width-1-1 uk-width-expand@s">
                <input
                  id="domainChatFile"
                  class="uk-input"
                  type="file"
                  accept=".md,.markdown,.html,.htm,.txt"
                  data-domain-chat-upload
                >
              </div>
              <div class="uk-width-1-1 uk-width-auto@s uk-flex uk-flex-bottom uk-flex-right@s">
                <button type="submit" class="uk-button uk-button-primary uk-width-1-1" data-domain-chat-submit>
                  {{ t('button_domain_chat_upload') }}
                </button>
              </div>
            </div>
          </div>
          <p class="uk-text-meta uk-margin-small-top">{{ t('text_domain_chat_file_hint')|format(domainChatMaxSize) }}</p>
        </div>
        <div class="uk-width-1-2 uk-width-auto@m uk-flex uk-flex-bottom">
          <button type="button" class="uk-button uk-button-default uk-width-1-1" data-domain-chat-rebuild>
            {{ t('button_domain_chat_rebuild') }}
          </button>
        </div>
        <div class="uk-width-1-1 uk-width-auto@m uk-flex uk-flex-bottom">
          <button type="button" class="uk-button uk-button-default uk-width-1-1" data-domain-chat-download>
            {{ t('button_domain_chat_download') }}
          </button>
        </div>
      </form>
      <div class="uk-margin-small" data-domain-chat-status aria-live="polite"></div>
      <div class="uk-overflow-auto uk-margin">
        <table class="uk-table uk-table-divider uk-table-small" data-domain-chat-table>
          <thead>
            <tr>
              <th>{{ t('column_domain_chat_name') }}</th>
              <th class="uk-table-shrink">{{ t('column_domain_chat_size') }}</th>
              <th class="uk-table-shrink">{{ t('column_domain_chat_updated') }}</th>
              <th class="uk-table-shrink">{{ t('column_actions') }}</th>
            </tr>
          </thead>
          <tbody data-domain-chat-body>
            <tr>
              <td colspan="4">{{ t('text_domain_chat_loading') }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="uk-margin-large" data-domain-chat-wiki>
        <h4 class="uk-heading-bullet uk-margin-remove">{{ t('heading_domain_chat_wiki') }}</h4>
        <p class="uk-text-meta uk-margin-small" data-domain-chat-wiki-description>{{ t('text_domain_chat_wiki_hint') }}</p>
        <div class="uk-alert uk-alert-warning uk-margin-small" data-domain-chat-wiki-message hidden></div>
        <ul class="uk-list uk-list-divider uk-margin-small" data-domain-chat-wiki-list hidden></ul>
        <div class="uk-margin-small-top">
          <button type="button" class="uk-button uk-button-primary" data-domain-chat-wiki-save disabled>
            {{ t('button_domain_chat_wiki_save') }}
          </button>
        </div>
      </div>
    </div>
  </div>
{% endif %}
