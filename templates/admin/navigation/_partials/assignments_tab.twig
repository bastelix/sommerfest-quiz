{# Assignments Tab: Namespace standards (header + footer slots) and page-specific overrides with inline accordion #}
{% set activePageNamespace = pageNamespace|default('default') %}
{% set menuDefinitions = menu_definitions|default([]) %}
{% set hasMenus = menuDefinitions is not empty %}
{% set localeOptions = locale_options|default(['de', 'en']) %}

{# ── Section 1: Namespace Standards ── #}
<div
  class="uk-card uk-card-default uk-card-body uk-margin-small"
  data-menu-standards
  data-base-path="{{ basePath }}"
>
  <div class="uk-flex uk-flex-between uk-flex-middle uk-flex-wrap">
    <div>
      <div class="uk-text-meta uk-text-uppercase">{{ t('label_navigation_standards') }}</div>
      <h3 class="uk-card-title uk-margin-remove">{{ t('label_navigation_standards_title') }}</h3>
    </div>
  </div>
  <p class="uk-text-meta uk-margin-small-top">{{ t('text_navigation_standards_hint') }}</p>
  <div class="uk-alert uk-alert-primary uk-margin-small" data-menu-standards-feedback hidden role="status"></div>

  <div class="uk-margin">
    <h4 class="uk-heading-bullet">{{ t('label_navigation_header_standard') }}</h4>
    <div class="uk-grid-small uk-child-width-1-1 uk-child-width-1-3@m" uk-grid>
      <div>
        <label class="uk-form-label" for="headerStandardLocaleSelect">Locale</label>
        <div class="uk-form-controls">
          <select id="headerStandardLocaleSelect" class="uk-select" data-header-locale-select>
            {% for localeOption in localeOptions %}
              <option value="{{ localeOption|e('html_attr') }}">{{ localeOption }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div>
        <label class="uk-form-label" for="headerStandardMenuSelect">{{ t('label_navigation_header_menu') }}</label>
        <div class="uk-form-controls">
          <select
            id="headerStandardMenuSelect"
            class="uk-select"
            data-header-menu-select
            {% if not hasMenus %}disabled data-locked-disabled="true"{% endif %}
          >
            <option value="">{{ t('label_navigation_unassigned') }}</option>
            {% for menu in menuDefinitions %}
              <option value="{{ menu.id }}" data-menu-locale="{{ menu.locale|e('html_attr') }}">
                {{ menu.label }} ({{ menu.locale }})
              </option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
    <div class="uk-text-meta uk-margin-small-top">
      {{ t('text_navigation_header_standard_hint') }}
    </div>
  </div>

  <hr class="uk-divider-icon">

  <div class="uk-margin">
    <h4 class="uk-heading-bullet">{{ t('label_navigation_footer_standard') }}</h4>
    <div class="uk-grid-small uk-child-width-1-1 uk-child-width-1-4@m" uk-grid>
      <div>
        <label class="uk-form-label" for="footerStandardLocaleSelect">Locale</label>
        <div class="uk-form-controls">
          <select id="footerStandardLocaleSelect" class="uk-select" data-footer-locale-select>
            {% for localeOption in localeOptions %}
              <option value="{{ localeOption|e('html_attr') }}">{{ localeOption }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      {% for slot in ['footer_1', 'footer_2', 'footer_3'] %}
        <div>
          <label class="uk-form-label" for="footerStandardSelect{{ loop.index }}">Slot {{ loop.index }}</label>
          <div class="uk-form-controls">
            <select
              id="footerStandardSelect{{ loop.index }}"
              class="uk-select"
              data-footer-select="{{ slot }}"
              {% if not hasMenus %}disabled data-locked-disabled="true"{% endif %}
            >
              <option value="">{{ t('label_navigation_unassigned') }}</option>
              {% for menu in menuDefinitions %}
                <option value="{{ menu.id }}" data-menu-locale="{{ menu.locale|e('html_attr') }}">
                  {{ menu.label }} ({{ menu.locale }})
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
      {% endfor %}
    </div>
    <div class="uk-text-meta uk-margin-small-top">
      {{ t('text_navigation_footer_standard_hint') }}
    </div>
  </div>
</div>

{# ── Section 2: Page-specific Overrides ── #}
{% set overrideLocaleOptions = override_locale_options|default(localeOptions) %}
<div
  class="uk-card uk-card-default uk-card-body uk-margin"
  data-navigation-overrides-list
>
  <div class="uk-flex uk-flex-between uk-flex-middle uk-flex-wrap">
    <div>
      <div class="uk-text-meta uk-text-uppercase">{{ t('label_navigation_overrides') }}</div>
      <h3 class="uk-card-title uk-margin-remove">{{ t('label_navigation_overrides_title') }}</h3>
    </div>
  </div>
  <p class="uk-text-meta uk-margin-small-top">{{ t('text_navigation_overrides_hint') }}</p>

  <div class="uk-grid-small uk-child-width-1-1 uk-child-width-1-4@m uk-margin-small-top" uk-grid>
    <div>
      <label class="uk-form-label" for="overrideLocaleFilter">Locale</label>
      <div class="uk-form-controls">
        <select id="overrideLocaleFilter" class="uk-select" data-override-locale-filter>
          <option value="">Alle</option>
          {% for localeOption in overrideLocaleOptions %}
            <option value="{{ localeOption|e('html_attr') }}">{{ localeOption }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div>
      <label class="uk-form-label" for="overrideHeaderFilter">Header</label>
      <div class="uk-form-controls">
        <select id="overrideHeaderFilter" class="uk-select" data-override-header-filter>
          <option value="">Alle</option>
          <option value="standard">Standard</option>
          <option value="override">Override</option>
        </select>
      </div>
    </div>
    <div>
      <label class="uk-form-label" for="overrideFooterFilter">Footer</label>
      <div class="uk-form-controls">
        <select id="overrideFooterFilter" class="uk-select" data-override-footer-filter>
          <option value="">Alle</option>
          <option value="standard">Standard</option>
          <option value="override">Override</option>
        </select>
      </div>
    </div>
    <div>
      <label class="uk-form-label" for="overrideSort">Sortierung</label>
      <div class="uk-form-controls">
        <select id="overrideSort" class="uk-select" data-override-sort>
          <option value="title">Seitentitel</option>
          <option value="updated">Zuletzt geändert</option>
        </select>
      </div>
    </div>
  </div>

  <div class="uk-overflow-auto admin-table-wrapper uk-margin-small-top">
    <table class="uk-table uk-table-divider uk-table-small uk-table-middle">
      <thead>
        <tr>
          <th>Seite</th>
          <th class="uk-table-shrink">Slug</th>
          <th class="uk-table-shrink">Header</th>
          <th class="uk-table-shrink">Footer</th>
          <th class="uk-table-shrink">Zuletzt geändert</th>
          <th class="uk-table-shrink uk-text-right">Aktionen</th>
        </tr>
      </thead>
      <tbody data-override-rows>
        {% for page in page_overrides|default([]) %}
          {% set headerLocales = page.header_locales|default([]) %}
          {% set footerLocales = page.footer_locales|default([]) %}
          <tr
            data-override-row
            data-page-title="{{ page.title|default(page.slug)|e('html_attr') }}"
            data-page-updated="{{ page.updated_at|default('')|e('html_attr') }}"
            data-header-override="{{ page.has_header_override ? '1' : '0' }}"
            data-footer-override="{{ page.has_footer_override ? '1' : '0' }}"
            data-header-locales="{{ headerLocales|join(',')|e('html_attr') }}"
            data-footer-locales="{{ footerLocales|join(',')|e('html_attr') }}"
          >
            <td>
              <strong>{{ page.title|default(page.slug) }}</strong>
              {% if headerLocales is not empty or footerLocales is not empty %}
                <div class="uk-text-meta">
                  {% if headerLocales is not empty %}Header: {{ headerLocales|join(', ') }}{% endif %}
                  {% if headerLocales is not empty and footerLocales is not empty %} · {% endif %}
                  {% if footerLocales is not empty %}Footer: {{ footerLocales|join(', ') }}{% endif %}
                </div>
              {% else %}
                <div class="uk-text-meta">Keine Overrides gesetzt.</div>
              {% endif %}
            </td>
            <td>/{{ page.slug }}</td>
            <td>
              {% if page.has_header_override %}
                <span class="uk-label uk-label-success">Override</span>
              {% else %}
                <span class="uk-label">Standard</span>
              {% endif %}
            </td>
            <td>
              {% if page.has_footer_override %}
                <span class="uk-label uk-label-success">Override</span>
              {% else %}
                <span class="uk-label">Standard</span>
              {% endif %}
            </td>
            <td>{{ page.updated_at ? page.updated_at|date('d.m.Y H:i') : '—' }}</td>
            <td class="uk-text-right">
              <button
                type="button"
                class="uk-button uk-button-primary uk-button-small"
                data-override-toggle-detail="{{ page.id }}"
              >Details</button>
            </td>
          </tr>
          <tr class="uk-background-muted" data-override-detail-row="{{ page.id }}" hidden>
            <td colspan="6">
              <div
                class="uk-padding-small"
                data-menu-overrides-detail
                data-base-path="{{ basePath }}"
                data-page-id="{{ page.id }}"
              >
                <div class="uk-alert uk-alert-primary uk-margin-small" data-menu-overrides-feedback hidden role="status"></div>

                <div class="uk-margin-small">
                  <label class="uk-form-label">Locale</label>
                  <div class="uk-form-controls">
                    <select class="uk-select uk-form-small uk-form-width-small" data-override-locale-select>
                      {% for localeOption in localeOptions %}
                        <option value="{{ localeOption|e('html_attr') }}">{{ localeOption }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>

                <div class="uk-grid-small uk-child-width-1-1 uk-child-width-1-2@m" uk-grid>
                  <div>
                    <h5 class="uk-margin-small-bottom">{{ t('label_navigation_header_override') }}</h5>
                    <label class="uk-form-label">{{ t('label_navigation_header_menu') }}</label>
                    <div class="uk-form-controls">
                      <select
                        class="uk-select uk-form-small"
                        data-header-menu-select
                        {% if not hasMenus %}disabled data-locked-disabled="true"{% endif %}
                      >
                        <option value="">{{ t('label_navigation_automatic') }}</option>
                        {% for menu in menuDefinitions %}
                          <option value="{{ menu.id }}" data-menu-locale="{{ menu.locale|e('html_attr') }}">
                            {{ menu.label }} ({{ menu.locale }})
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  <div>
                    <h5 class="uk-margin-small-bottom">{{ t('label_navigation_footer_override') }}</h5>
                    <div class="uk-margin-small">
                      <label class="uk-flex uk-flex-middle">
                        <input class="uk-checkbox" type="checkbox" data-footer-override-toggle>
                        <span class="uk-margin-small-left">{{ t('label_navigation_footer_override_toggle') }}</span>
                      </label>
                    </div>
                    <div class="uk-grid-small uk-child-width-1-3" uk-grid>
                      {% for slot in ['footer_1', 'footer_2', 'footer_3'] %}
                        <div>
                          <label class="uk-form-label">Slot {{ loop.index }}</label>
                          <div class="uk-form-controls">
                            <select
                              class="uk-select uk-form-small"
                              data-footer-override-select="{{ slot }}"
                              {% if not hasMenus %}disabled data-locked-disabled="true"{% endif %}
                            >
                              <option value="">{{ t('label_navigation_automatic') }}</option>
                              {% for menu in menuDefinitions %}
                                <option value="{{ menu.id }}" data-menu-locale="{{ menu.locale|e('html_attr') }}">
                                  {{ menu.label }} ({{ menu.locale }})
                                </option>
                              {% endfor %}
                            </select>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        {% else %}
          <tr data-override-empty>
            <td colspan="6">Keine Seiten vorhanden.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  (() => {
    document.querySelectorAll('[data-override-toggle-detail]').forEach(btn => {
      btn.addEventListener('click', () => {
        const pageId = btn.dataset.overrideToggleDetail;
        const detailRow = document.querySelector('[data-override-detail-row="' + pageId + '"]');
        if (!detailRow) return;
        const isHidden = detailRow.hidden;
        detailRow.hidden = !isHidden;
        btn.textContent = isHidden ? 'Schließen' : 'Details';
      });
    });
  })();
</script>
