<!DOCTYPE html>
{% set cfg = config is defined ? config : {} %}
{% set lang = lang|default(locale()) %}
{% set resolvedNamespace = designNamespace|default(namespace|default(pageNamespace|default(marketingNamespace|default(cfg.namespace|default('default'))), true)) %}
{% set normalizedNamespace = resolvedNamespace|trim|lower %}
{% set themeValue %}{% block body_theme %}{{ pageTheme|default(design.theme|default('light')) }}{% endblock %}{% endset %}
{% set resolvedTheme = themeValue|trim %}
{% set bodyClassRaw %}{% block body_class %}{% endblock %}{% endset %}
{% set normalizedBodyClass = bodyClassRaw|trim %}
{% set isAdminPage = 'admin-page' in normalizedBodyClass %}
{% set includeMarketingThemeVars = includeMarketingThemeVars|default(false) %}
{% set shouldIncludeMarketingThemeVars = (not isAdminPage) or ('marketing-page' in normalizedBodyClass) or includeMarketingThemeVars %}
{% set includeUikitStyles = includeUikitStyles|default(true) %}
{% set includeMainStyles = includeMainStyles|default(true) %}
{% set includeVariablesStyles = includeVariablesStyles|default(true) %}
{% set includeTableStyles = includeTableStyles|default(true) %}
{% set includeTopbarStyles = includeTopbarStyles|default(true) %}
{% set includeNamespaceTokensStyles = includeNamespaceTokensStyles|default(true) %}
{% set enableNamespaceTokenDiagnostics = displayErrorDetails|default(false) %}
{% set activeNamespace = normalizedNamespace|default('default') %}
{% set hasNamespaceStyles = activeNamespace is not empty and activeNamespace != 'default' %}
{% set namespaceSegment = hasNamespaceStyles ? '/' ~ activeNamespace : '' %}
{# Allowed admin layout profiles: wide, standard, narrow. #}
{% set allowedAdminLayouts = ['wide', 'standard', 'narrow'] %}
{% set adminLayoutRaw = adminLayout|default('') %}
{% set normalizedAdminLayout = adminLayoutRaw is same as(null) ? '' : adminLayoutRaw|trim|lower %}
{% set resolvedAdminLayout = null %}
{% if isAdminPage %}
  {% set resolvedAdminLayout = 'standard' %}
  {% if normalizedAdminLayout in allowedAdminLayouts %}
    {% set resolvedAdminLayout = normalizedAdminLayout %}
  {% elseif normalizedAdminLayout %}
    {% set resolvedAdminLayout = 'standard' %}
  {% endif %}
{% endif %}
{% set mergedBodyClass = normalizedBodyClass ~ (isAdminPage ? (normalizedBodyClass ? ' ' : '') ~ 'admin-shell' : '') %}
<html
  lang="{{ lang }}"
  data-namespace="{{ normalizedNamespace }}"
  data-theme="{{ resolvedTheme }}"
  data-base-path="{{ basePath }}"
>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  {% set defaultTitle = 'QuizRace – Das interaktive Team-Quiz für Events' %}
  {% set effectiveTitle = metaTitle|default(defaultTitle) %}
  <title>{% block title %}{{ effectiveTitle }}{% endblock %}</title>
  {% set defaultDescription = 'QuizRace macht Ihr Event einzigartig: QR-Code-Stationen, Live-Ranking & Rätselspaß – datensicher, flexibel, ohne App-Download.' %}
  {% set effectiveDescription = metaDescription|default(defaultDescription) %}
  <meta name="description" content="{{ effectiveDescription }}">
  {% set effectiveRobots = robotsMeta|default('index, follow') %}
  <meta name="robots" content="{{ effectiveRobots }}">
  {% set effectiveCanonical = canonicalUrl|default('') %}
  {% if effectiveCanonical %}
  <link rel="canonical" href="{{ effectiveCanonical }}">
  {% endif %}
  {% set effectiveOgTitle = ogTitle|default(effectiveTitle) %}
  <meta property="og:title" content="{{ effectiveOgTitle }}">
  {% set effectiveOgDescription = ogDescription|default(effectiveDescription) %}
  <meta property="og:description" content="{{ effectiveOgDescription }}">
  {% set defaultOgImage = baseUrl ~ (config.ogImagePath ?? '/uploads/seo/social-preview.jpg') %}
  {% if ogImage is defined and ogImage %}
    {% if ogImage matches '/^https?:\\/\\//i' %}
      {% set effectiveOgImage = ogImage %}
    {% else %}
      {% set effectiveOgImage = baseUrl ~ ogImage %}
    {% endif %}
  {% else %}
    {% set effectiveOgImage = defaultOgImage %}
  {% endif %}
  <meta property="og:image" content="{{ effectiveOgImage }}">
    {% if effectiveCanonical %}
    <meta property="og:url" content="{{ effectiveCanonical }}">
    {% endif %}
    <meta property="og:type" content="website">
    <meta property="og:locale" content="de_DE">
    <meta name="twitter:card" content="summary_large_image">
  {% if hreflangLinks is defined and hreflangLinks is not empty %}
    {% for link in hreflangLinks %}
      <link rel="alternate" href="{{ link.href }}" hreflang="{{ link.hreflang }}">
    {% endfor %}
  {% elseif hreflang is defined and hreflang and effectiveCanonical %}
    {% set hreflangCodes = hreflang|split(',') %}
    {% for code in hreflangCodes %}
      {% set trimmedCode = code|trim %}
      {% if trimmedCode %}
      <link rel="alternate" href="{{ effectiveCanonical }}" hreflang="{{ trimmedCode }}">
      {% endif %}
    {% endfor %}
  {% else %}
  <link rel="alternate" href="https://quizrace.app/" hreflang="de">
  {% endif %}
  {% if schemaJson is defined and schemaJson %}
  <script type="application/ld+json">
  {{ schemaJson|raw }}
  </script>
  {% else %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "QuizRace",
    "url": "https://quizrace.app/",
    "description": "QuizRace ist das interaktive Event-Quiz mit QR-Code-Stationen, Live-Ranking & Rätselspaß – datensicher, flexibel, ohne App-Download.",
    "publisher": {
      "@type": "Organization",
      "name": "QuizRace",
      "logo": {
        "@type": "ImageObject",
        "url": "https://quizrace.app/uploads/branding/logo.png"
      }
    },
    "sameAs": [
      "https://www.facebook.com/quizrace",
      "https://www.instagram.com/quizrace",
      "https://www.linkedin.com/company/quizrace"
    ]
  }
  </script>
  {% endif %}
  {% set rawFavicon = pageFavicon is defined and pageFavicon ? pageFavicon : '/favicon.svg' %}
  {% set faviconSource = rawFavicon starts with 'http' ? rawFavicon : basePath ~ rawFavicon %}
  {% set faviconExt = (rawFavicon|split('?')|first|split('#')|first|split('.')|last|lower) %}
  {% set faviconType = 'image/svg+xml' %}
  {% if faviconExt in ['png'] %}
    {% set faviconType = 'image/png' %}
  {% elseif faviconExt in ['ico', 'cur'] %}
    {% set faviconType = 'image/x-icon' %}
  {% elseif faviconExt in ['jpg', 'jpeg'] %}
    {% set faviconType = 'image/jpeg' %}
  {% elseif faviconExt == 'gif' %}
    {% set faviconType = 'image/gif' %}
  {% elseif faviconExt == 'webp' %}
    {% set faviconType = 'image/webp' %}
  {% elseif faviconExt == 'svg' %}
    {% set faviconType = 'image/svg+xml' %}
  {% endif %}
  <link rel="icon" href="{{ faviconSource }}" type="{{ faviconType }}">
  {% if includeUikitStyles %}
    <link rel="stylesheet" href="{{ basePath }}/css/uikit.min.css">
  {% endif %}
  {% if includeVariablesStyles %}
    <link rel="stylesheet" href="{{ basePath }}/css/variables.css">
  {% endif %}
  {% set theme = attribute(cfg, 'startTheme')|default('light')|lower %}
  {% set prefersDark = theme == 'dark' %}
  {% set includeDarkStyles = includeDarkStyles|default(true) %}
  {% set shouldIncludeDarkStyles = includeMainStyles and includeVariablesStyles and includeDarkStyles %}
  {% set darkMedia = shouldIncludeDarkStyles ? (prefersDark ? 'all' : '(prefers-color-scheme: dark)') : 'not all' %}
  {% if shouldIncludeDarkStyles %}
    <link rel="stylesheet" href="{{ basePath }}/css/dark.css" media="{{ darkMedia }}"{% if not prefersDark or not shouldIncludeDarkStyles %} disabled{% endif %}>
  {% endif %}
  {% set namespaceTokensVersionsMap = namespaceTokensVersions|default({}) %}
  {% set namespaceTokensQuery = namespaceTokensVersionsMap[activeNamespace]|default(namespaceTokensVersion|default('now'|date('U'))) %}
  {% set namespaceTokensStyles = '' %}
  {% if includeNamespaceTokensStyles %}
    {% set namespaceTokensStyles %}
      <link
        rel="stylesheet"
        href="{{ basePath }}/css{{ namespaceSegment }}/namespace-tokens.css?v={{ namespaceTokensQuery }}"
        data-default-href="{{ basePath }}/css/namespace-tokens.css?v={{ namespaceTokensQuery }}"
        data-dev="{{ enableNamespaceTokenDiagnostics ? '1' : '0' }}"
        onerror="(function(el){var isDev=el.dataset&&el.dataset.dev==='1';if(isDev){var markFallback=function(){document.documentElement.setAttribute('data-namespace-token-fallback','1');};markFallback();if(!window.__namespaceTokenFallbackShown){window.__namespaceTokenFallbackShown=true;var banner=document.createElement('div');banner.textContent='Missing namespace token CSS: '+el.href;banner.style='position:fixed;top:0;left:0;right:0;z-index:10000;background:#b91c1c;color:#fff;padding:8px 12px;font:12px/1.4 sans-serif;text-align:center';var mount=function(){document.body.appendChild(banner);};if(document.body){mount();}else{document.addEventListener('DOMContentLoaded',mount);}}return;}if(el.dataset&&el.dataset.defaultHref){el.onerror=null;el.href=el.dataset.defaultHref;}})(this);"
      >
    {% endset %}
  {% endif %}
  {% if includeNamespaceTokensStyles and 'marketing-page' not in normalizedBodyClass %}
    {{ namespaceTokensStyles|raw }}
  {% endif %}
  {% if includeTableStyles %}
    <link rel="stylesheet" href="{{ basePath }}/css/table.css">
  {% endif %}
  {% if includeTopbarStyles and 'marketing-page' not in normalizedBodyClass %}
    <link rel="stylesheet" href="{{ basePath }}/css/topbar.css">
  {% endif %}
  {% if 'marketing-page' in normalizedBodyClass %}
  <link rel="preload" href="https://fonts.gstatic.com/s/poppins/v24/pxiEyp8kv8JHgFVrJJfecg.woff2" as="font" type="font/woff2" crossorigin>
  {% endif %}
  {% block head %}{% endblock %}
  {% block head_end %}
    {% if includeNamespaceTokensStyles and 'marketing-page' in normalizedBodyClass %}
      {{ namespaceTokensStyles|raw }}
    {% endif %}
    {% block theme_vars %}
      {# Marketing design injection only. Do not use on event/game/result pages. #}
      {% if shouldIncludeMarketingThemeVars %}
        {% include 'marketing/partials/theme-vars.twig' %}
      {% endif %}
    {% endblock %}
    {% if marketingDesignDebug is defined and marketingDesignDebug.enabled %}
      <!-- Marketing Design Debug: namespace={{ marketingDesignDebug.namespace }}, tokenCss={{ marketingDesignDebug.tokenCssUrl }}, fallback={{ marketingDesignDebug.fallback }}, version={{ marketingDesignDebug.version }} -->
    {% endif %}
  {% endblock %}
</head>
<body
  data-theme="{{ resolvedTheme }}"
  class="{{ mergedBodyClass }}"
  {% if resolvedAdminLayout %}data-admin-layout="{{ resolvedAdminLayout }}"{% endif %}
>
  <div class="wrapper">
    <main class="content">
      {% block body %}{% endblock %}
    </main>
    <footer class="site-footer">
      {% block footer %}
        {% import 'marketing/partials/footer-menu.twig' as footerMenu %}
        {% set footerColumns = cmsFooterColumns|default([]) %}
        {% set legalLinks = cmsLegalNavigation|default([]) %}

        {% if footerColumns or legalLinks %}
          <div class="footer-columns">
            {% if footerColumns %}
              <div class="footer-section footer-navigation">
                <strong>{{ t('navigation') }}</strong>
                {{ footerMenu.render_columns(
                  footerColumns,
                  'footer-navigation-grid uk-grid-small uk-child-width-1-1 uk-child-width-1-3@m',
                  'footer-navigation-column',
                  'uk-grid'
                ) }}
              </div>
            {% endif %}
            {% if legalLinks %}
              <div class="footer-section footer-legal">
                <strong>{{ t('privacy') }}</strong>
                {{ footerMenu.render_links(legalLinks) }}
              </div>
            {% endif %}
          </div>
        {% else %}
          <div class="uk-text-center">
            <a href="{{ basePath }}/impressum">{{ t('imprint') }}</a> |
            <a href="{{ privacyUrl }}">{{ t('privacy') }}</a> |
            <a href="{{ basePath }}/lizenz">{{ t('license') }}</a>
          </div>
        {% endif %}
      {% endblock %}
    </footer>
  </div>
  <script src="{{ basePath }}/js/uikit.min.js" defer></script>
  <script src="{{ basePath }}/js/uikit-icons.min.js" defer></script>
  <script src="{{ basePath }}/js/storage.js" defer></script>
  <script src="{{ basePath }}/js/app.js" defer></script>
  <script src="{{ basePath }}/js/i18n/{{ locale() == 'en' ? 'en-us' : 'de-de' }}.js" defer></script>
  <script type="module" src="{{ basePath }}/js/frontend-hydrator.js"></script>
  {% block scripts %}{% endblock %}
</body>
</html>
